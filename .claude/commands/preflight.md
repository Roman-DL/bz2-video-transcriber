# Pre-flight check перед реализацией

Изучи архитектуру проекта и помоги спроектировать фичу с учётом существующей системы.

> **Главная цель:** понять как построить фичу, чтобы она органично вписалась в архитектуру.

## Входные данные

**Аргумент:** $ARGUMENTS

### Определение источника задачи

1. **Если аргумент — путь к файлу** (например, `docs/plans/auth.md`):
   - Прочитай указанный файл плана
   - Используй его как описание задачи для проверки

2. **Если аргумент — описание задачи** (текст):
   - Используй переданное описание

3. **Если аргумент пустой или отсутствует**:
   - Проверь контекст текущей беседы
   - Найди последний обсуждённый план или задачу
   - Если не найдено — попроси пользователя уточнить

## Цель

**Спроектировать фичу с учётом архитектуры:**
1. Понять как устроена система — компоненты, связи, паттерны
2. Проверить совместимость плана с принятыми решениями (ADR)
3. Определить как именно интегрировать фичу в существующую структуру
4. Выявить потенциальные конфликты до начала реализации

> **Примечание:** Предварительный список документов для обновления — побочный результат анализа. Окончательную проверку выполнит `/finalize` после реализации.

---

## Шаг 1: Изучить архитектуру

### ARCHITECTURE.md + docs/architecture/

Прочитай `docs/ARCHITECTURE.md` (обзор системы) и разберись:
- Какие компоненты есть в системе
- Как они связаны между собой
- Какие технологии используются
- Где находится код для разных частей системы

Если есть `docs/architecture/` — прочитай модульные документы для затрагиваемых подсистем:
- Какие решения уже приняты для этого модуля
- Какие потоки данных, таблицы, API существуют
- Как новая фича интегрируется с описанной архитектурой

### docs/pipeline/ (ключевая подсистема)

Если задача затрагивает pipeline — изучи `docs/pipeline/`:
- Документация по этапам обработки (14 файлов)
- Как новый этап интегрируется с существующими
- Какие решения приняты по каждому этапу

### decisions/ (ADR)

Просмотри `docs/decisions/` и найди релевантные ADR:
- Почему выбраны текущие подходы
- Какие альтернативы рассматривались
- Какие ограничения это накладывает

### CLAUDE.md

Проверь ограничения в `CLAUDE.md`:
- Что AI НЕ должен делать
- Какие паттерны обязательны
- Текущий статус проекта

---

## Шаг 1.5: Проверить rules для затрагиваемых модулей

Определи какие модули (`backend/app/services/*/`) будут затронуты задачей, затем проверь:

1. **Есть ли `.claude/rules/` файл** для каждого затрагиваемого модуля?
2. **Если есть** — прочитай и учти при проектировании (паттерны, ограничения)
3. **Если нет** — отметь в отчёте: "Нет rules для {модуль} — рекомендуется создать после реализации"

> Это гарантирует что архитектурные правила загружены в контекст **до** начала реализации.

---

## Шаг 2: Проверить совместимость

На основе изученной архитектуры определи:

**Вписывается ли задача в текущую архитектуру?**
- Если да — какие компоненты затронет
- Если нет — нужно ли менять архитектуру (и создавать ADR)

**Есть ли конфликты с существующими решениями?**
- Противоречит ли задача каким-то ADR
- Нарушает ли ограничения из CLAUDE.md

---

## Шаг 3: Предварительная оценка документации

На основе анализа предположи какие документы **вероятно** потребуют обновления:

- **ARCHITECTURE.md** — новый компонент, изменение структуры?
- **architecture/{module}.md** — нужен ли новый документ или обновление существующего?
- **docs/pipeline/** — новый этап, изменение существующего?
- **ADR** — выбор подхода, новая абстракция?
- **CLAUDE.md** — новые ограничения?

> Это предварительный список. После реализации `/finalize` проверит фактические изменения и поймает то, что не было предусмотрено.

---

## Шаг 4: Вывод результата

### Куда выводить результат

1. **Если источник — файл плана:**
   - Добавь секцию `## Pre-flight результат` в конец файла плана
   - Сообщи пользователю что план обновлён

2. **Если источник — контекст беседы или описание:**
   - Выведи результат в беседу
   - Предложи добавить в план если план существует

---

## Формат ответа

```markdown
## Pre-flight: {название задачи}

### Архитектурный контекст

**Релевантные компоненты:**
- {компонент 1} — {роль в задаче, как использовать}
- {компонент 2} — {роль в задаче, как использовать}

**Релевантные ADR:**
- {ADR-NNN: название} — {как влияет на реализацию}
- или "Релевантных ADR не найдено"

**Ограничения из CLAUDE.md:**
- {ограничение если есть}
- или "Конфликтов с ограничениями нет"

**Rules (.claude/rules/):**
- {модуль}: {есть — учтены паттерны / нет — создать после реализации}

### Рекомендации по интеграции

{Как именно реализовать фичу с учётом архитектуры:}
- {где разместить код}
- {какие паттерны использовать}
- {с какими компонентами интегрировать}

### Оценка совместимости

{Вписывается / Требует изменений архитектуры}

{Если требует изменений — что именно и нужен ли ADR}

### Вероятные обновления документации

- ARCHITECTURE.md (обзор) — {да/нет/возможно}: {что}
- architecture/{module}.md — {создать/обновить/не нужно}: {какой модуль}
- docs/pipeline/ — {создать/обновить/не нужно}: {какой этап}
- ADR — {да/нет/возможно}: {какой}
- CLAUDE.md — {возможно}: {если что-то}

> Окончательный список определит `/finalize` после реализации

### Готов к реализации

{Да / Нет, потому что...}
```

---

## Примечание

Этот чеклист — направление для анализа, не жёсткий список. Если в проекте есть другие важные документы (например, reference/, patterns/) — изучи их тоже.

---

## Примеры вызова

```bash
# Проверка по файлу плана (новая беседа после планирования)
/preflight docs/plans/auth-oauth.md

# Проверка по описанию задачи
/preflight Добавить новый этап в pipeline

# Проверка плана из контекста беседы (после Plan Mode)
/preflight
```

---

_Команда: /preflight [описание задачи | путь к плану | пусто]_
