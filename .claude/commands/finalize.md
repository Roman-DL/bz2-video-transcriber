# Финализация после реализации

Проанализируй фактические изменения и актуализируй документацию.

> **Скоуп:** Только затронутые модули — "что изменилось сейчас?"
> **Для полного аудита проекта** — используй `/sync-docs`.
> **Роль:** Страховочная сетка — ловит всё, что не было предусмотрено при планировании.

## Когда вызывать

1. **После завершения фазы/фичи** — проверить что документация актуальна
2. **После изменений без планирования** — быстрые фиксы, эксперименты

## Контекст

Пользователь завершил реализацию. Даже если был `/preflight`, в процессе могли появиться непредвиденные изменения. Задача — убедиться что документация отражает **фактическое** состояние проекта.

---

## Шаг 1: Понять что изменилось

Проанализируй изменения в коде:
- Какие файлы созданы или существенно изменены?
- Какие компоненты затронуты?
- Какие решения были приняты в процессе?
- Были ли неожиданные сложности или edge cases?

---

## Шаг 1.5: Проверить соответствие rules

Для каждого затронутого модуля, у которого есть `.claude/rules/` файл:

1. **Сравни реализацию с правилами** — следует ли новый код паттернам из rules?
2. **Если расхождение:**
   - Покажи конкретно: "В `{rule-файл}` указано X, но реализация делает Y"
   - Спроси пользователя: **это осознанное изменение архитектуры или дрифт?**
   - Если осознанное → обнови rule и предложи ADR если изменение значительное
   - Если дрифт → предложи исправить код
3. **Если для модуля нет rules** — предложи создать на основе реализованных паттернов

> Rules обновляются только с подтверждения пользователя. Никогда не обновлять молча.

---

## Шаг 2: Проверить документацию

### ARCHITECTURE.md (обзор)

Нужно ли обновить если:
- Добавлен новый компонент или модуль
- Изменилась структура директорий
- Добавлена новая технология или зависимость
- Изменились связи между компонентами

### docs/architecture/ (модульная архитектура)

Если в проекте используется `docs/architecture/`:

1. **Реализована новая подсистема?** → создать `docs/architecture/{NN}-{module}.md`
2. **Существенно изменена существующая?** → обновить соответствующий документ
3. **Обновить `docs/architecture/README.md`** — индекс, статусы

Критерии для создания нового документа:
- Новый сервис, таблица или внешняя интеграция
- Нетривиальный поток данных, который стоит зафиксировать
- Модуль с собственными решениями, API, схемой

Источники для документа:
- Реальный код (первичный источник — как устроено на самом деле)
- Requirement (если есть — что планировали)
- Plan (если сохранён — какие решения принимали)

> Architecture doc описывает **фактическое состояние**, не планы.

### docs/pipeline/ (документация pipeline)

Если изменения затронули pipeline:

1. **Новый этап?** → создать документ в `docs/pipeline/`
2. **Изменён существующий этап?** → обновить соответствующий документ в `docs/pipeline/`
3. **Обновить `docs/pipeline/README.md`** если структура изменилась

### decisions/ (ADR)

Нужен ли новый ADR если:
- Был выбор между несколькими подходами
- Создана новая абстракция или паттерн
- Интегрирован внешний сервис
- Принято решение с долгосрочными последствиями

### CLAUDE.md

Нужно ли обновить если:
- Обнаружен edge case который важно помнить
- AI сделал ошибку которую нужно предотвратить в будущем
- Появилось неочевидное требование
- Изменилась структура проекта

### Другие документы

Проверь также:
- reference/ — новые API или форматы данных?
- requirements/ — завершённые фичи для архивации?
- Временные планы (plan-*.md) — можно удалить?

---

## Шаг 3: Проверить размер CLAUDE.md

```bash
wc -l CLAUDE.md
```

- Если > 250 строк → предупредить о рефакторинге
- Если > 300 строк → настоятельно рекомендовать `/refactor-claude`

---

## Формат ответа

```markdown
## Финализация: {название фичи/фазы}

### Изменения в коде
{краткое описание что было сделано}

### Документация

**ARCHITECTURE.md (обзор):** {актуален / нужно обновить}
{если нужно — что именно добавить/изменить}

**architecture/ (модули):**
- {модуль}: {актуален / нужно обновить / нужно создать}

**docs/pipeline/:**
- {этап}: {актуален / нужно обновить / нужно создать}

**ADR:** {не нужен / нужен}
{если нужен — черновик или описание}

**CLAUDE.md:** {актуален / нужно обновить} ({N} строк)
{если нужно — что добавить}
{если > 250 строк: ⚠️ Рекомендуется `/refactor-claude`}

**Rules (.claude/rules/):**
- {модуль}: {соответствует / расхождение — описание / нет rules — создать?}

**Другое:** {если есть}

### Housekeeping
{список действий: архивация, удаление планов, обновление статуса}
```

После анализа — выполни изменения с подтверждением пользователя.

---

## Связь с /preflight

| Команда | Когда | Что делает |
|---------|-------|------------|
| `/preflight` | До реализации | Помогает спроектировать фичу с учётом архитектуры |
| `/finalize` | После реализации | Проверяет фактические изменения, ловит непредвиденное |

**Даже если был preflight** — finalize нужен потому что:
- В процессе реализации могли измениться решения
- Появились edge cases и новые ограничения
- Некоторые изменения стали очевидны только после написания кода

---

## Примечание

Это направление для анализа, не жёсткий чеклист. Ты можешь найти документы которые нужно обновить, даже если они не перечислены выше. Используй своё понимание проекта.

---

_Команда: /finalize_
