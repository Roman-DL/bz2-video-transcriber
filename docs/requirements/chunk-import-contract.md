# Контракт импорта чанков

> Спецификация взаимодействия между внешней системой обработки видео (bz2-video-transcribe) и BZ2-Bot

**Версия контракта:** 1.0
**Обновлено:** 9 февраля 2026

---

## Обзор

Внешняя система (bz2-video-transcribe) обрабатывает видео-записи мероприятий: транскрибирует, разбивает на смысловые чанки, добавляет контекст. Результат — JSON-файл, который загружается в BZ2-Bot через админ-портал.

```
Видео → [bz2-video-transcribe] → JSON → [Admin Portal] → Embeddings → Поиск
```

### Предварительные условия

- Материал уже создан в BZ2-Bot (есть `material_id`, `title`, `section_id`)
- Тип материала: `topic_video` или `topic_longread` (остальные типы отклоняются)
- Загрузка через форму материала в админ-портале (кнопка "Импорт чанков")

---

## Целевой JSON-формат

```json
{
  "version": "1.0",
  "materials": [
    {
      "description": "Закрытие полной оценки: работа с возражениями и сомнениями клиентов. Скрипты и готовые тексты для ответов на возражения. Как реагировать на «я подумаю», работа с возвратами, перевод скептика в клиента. Техника заучивания скриптов, адаптация под свою интонацию. Уверенность при проведении встреч. Разница между экспресс-оценкой и полной оценкой, 100 встреч для навыка. Настройка рекламной кампании, поиск клиентов. Спикер: Иванова А., ПШ Супервайзеры, 22.01.2026.",
      "short_description": "Работа с возражениями при закрытии полной оценки — скрипты и техники",
      "metadata": {
        "video_id": "2026-01-22_ПШ-SV_тестовая-запись",
        "speaker": "Иванова А.",
        "event_type": "ПШ",
        "stream": "SV",
        "stream_name": "Понедельничная Школа — Супервайзеры",
        "date": "2026-01-22",
        "duration_formatted": "00:05:01",
        "whisper_model": "large-v3-turbo"
      },
      "chunks": [
        {
          "text": "Тема: Закрытие полной оценки — работа с возражениями.\nСпикер: Иванова А., Понедельничная Школа — Супервайзеры.\n\nСпасибо всем, кто присоединился, особенно тем, кто на более серьёзной школе впервые. Сегодня мы будем говорить про полную оценку...",
          "metadata": {
            "chunk_id": "2026-01-22_ПШ-SV_тестовая-запись_001",
            "chunk_index": 1,
            "topic": "Закрытие полной оценки — работа с возражениями",
            "word_count": 414
          }
        }
      ]
    }
  ]
}
```

### Поля `materials[]` элемента

| Поле | Обязательно | Тип | Описание |
|------|:-----------:|-----|----------|
| `chunks` | да | array | Массив чанков (не пустой) |
| `description` | нет | string | Семантический индекс материала: ключевые темы, понятия, косвенные термины. Используется для embedding файлового поиска |
| `short_description` | нет | string | Краткое описание (1-2 предложения). Выводится в Telegram при доставке материала вместе со ссылкой |
| `metadata` | нет | object | Метаданные материала (спикер, мероприятие, дата и т.д.). Сохраняются в `materials.metadata` JSONB, отображаются в админке |
| `source_type` | нет | string | Тип источника. По умолчанию `"transcript"` |
| `trust_tier` | нет | int | Уровень доверия. По умолчанию `2` |

> `material_id` подставляется из URL эндпоинта — передавать в JSON не нужно.

### Поля чанка

| Поле | Обязательно | Тип | Описание |
|------|:-----------:|-----|----------|
| `text` | да | string | Текст чанка с контекстом. **Основное поле** — из него генерируется embedding (vector search) и full-text search индекс. Также передаётся в LLM при генерации ответа |
| `metadata` | нет | object | Произвольные метаданные. Сохраняются как JSONB, отображаются в админке |

### Формирование `text`

Контекст (тема, спикер, мероприятие) включается **прямо в тело `text`** — так он участвует во всех этапах поиска:

```
Тема: {topic}
Спикер: {speaker}, {stream_name}.

{оригинальный текст транскрипта}
```

Формат контекстной «шапки» свободный — главное, чтобы информация была в теле чанка.

### Формирование `description`

Описание — **семантический индекс материала** для файлового поиска. Из него генерируется embedding, по которому пользователь находит материал даже косвенными запросами ("найди материалы про набор мышечной массы", "где описан куркумин").

Должно содержать:
- Ключевые темы и понятия, обсуждаемые в материале
- Косвенные термины, по которым могут искать (синонимы, связанные понятия)
- Контекст: спикер, мероприятие, дата
- Практические аспекты: что можно узнать из материала

**Пример для документа (продукт Формула 1):**
```
Полное руководство по Формуле 1 Herbalife: состав, пищевая ценность, способы применения, рецепты коктейлей. Заменитель приема пищи для снижения и поддержания веса. Информация о вкусах (шоколад, ванилия, клубника, капучино), дозировках, противопоказаниях. Как презентовать продукт клиентам, ответы на частые вопросы. Научное обоснование эффективности, сравнение с аналогами. Базовое питание, сбалансированный рацион, контроль калорий, белковое питание.
```

**Пример для видео-транскрипта:**
```
Закрытие полной оценки: работа с возражениями и сомнениями клиентов. Скрипты и готовые тексты для ответов на возражения. Как реагировать на "я подумаю", работа с возвратами, перевод скептика в клиента. Техника заучивания скриптов, адаптация под свою интонацию. Уверенность при проведении встреч. Разница между экспресс-оценкой и полной оценкой, 100 встреч для навыка. Настройка рекламной кампании, поиск клиентов. Спикер: Иванова А., ПШ Супервайзеры, 22.01.2026.
```

> Для видео-транскриптов `description` может генерироваться AI-суммаризацией содержимого чанков на этапе обработки во внешней системе.

### Метаданные материала (`materials[].metadata`)

Информация об исходном материале и процессе обработки. Сохраняется в `materials.metadata` (JSONB), мержится с существующими метаданными. Отображается в админ-портале на странице материала.

| Поле | Описание | Пример |
|------|----------|--------|
| `video_id` | ID видео во внешней системе | `"2026-01-22_ПШ-SV_тестовая-запись"` |
| `speaker` | Спикер | `"Иванова А."` |
| `event_type` | Тип мероприятия | `"ПШ"` |
| `stream` | Код потока | `"SV"` |
| `stream_name` | Название потока | `"ПШ — Супервайзеры"` |
| `date` | Дата мероприятия | `"2026-01-22"` |
| `duration_formatted` | Длительность видео | `"00:05:01"` |
| `whisper_model` | Модель транскрибации | `"large-v3-turbo"` |

### Метаданные чанка (`chunks[].metadata`)

Информация о конкретном чанке. Сохраняется в `embeddings.source_metadata` (JSONB).

| Поле | Описание | Пример |
|------|----------|--------|
| `chunk_id` | Уникальный ID чанка во внешней системе | `"2026-01-22_ПШ-SV_001"` |
| `chunk_index` | Порядковый номер чанка | `1` |
| `topic` | Тема чанка (оригинал, до вставки в text) | `"Работа с возражениями"` |
| `word_count` | Количество слов | `414` |

---

## Как контекст влияет на поиск

В BZ2-Bot два режима поиска, они используют **разные embeddings**:

### 1. Файловый поиск ("найди документ")

```
Запрос → embedding → сравнение с material-level embedding → список материалов
```

- Material-level embedding генерируется из `title | description` материала
- **Поле `description`** из JSON обновляет описание → влияет на качество файлового поиска
- Чанки НЕ участвуют в файловом поиске

### 2. Q&A поиск ("ответь на вопрос")

```
Запрос → embedding → сравнение с content embeddings → топ чанков → LLM генерирует ответ
```

- Content embedding генерируется из `text` каждого чанка
- Найденные чанки передаются в Claude как контекст для ответа
- **Контекст в `text`** улучшает и поиск (embedding), и качество ответа (LLM видит тему)

### Схема: какое поле куда попадает

```
JSON                          БД                              Использование
─────────────────────────────────────────────────────────────────────────────
description          →  materials.description          →  FILE SEARCH embedding
                        (title | description)              chunk_type="material"

metadata             →  materials.metadata (merge)     →  отображение в админке
                                                          (спикер, мероприятие, дата...)

chunks[].text        →  embeddings.chunk_text          →  Q&A SEARCH embedding
                        + fts (tsvector, auto)             chunk_type="content"
                                                        →  LLM промпт (ответ)

chunks[].metadata    →  embeddings.source_metadata     →  отображение в админке
                                                          (topic, word_count...)
```

---

## Что происходит при импорте

1. JSON загружается как файл через `POST /api/materials/{id}/import-chunks`
2. `material_id` подставляется из URL — значение из JSON игнорируется
3. Если переданы `description` / `short_description` — обновляют поля материала
3a. Если передан `metadata` — мержится в `materials.metadata` (JSONB)
4. **Удаляются** все старые embeddings материала (delete-before-insert)
5. Создаётся **material-level embedding** (chunk_index=0) из `title | description`
6. Для каждого чанка создаётся **content embedding** (chunk_index=1, 2, ...)
7. Материал помечается `is_indexed=True`, `indexed_at=now`

**Важно:** повторный импорт полностью заменяет предыдущие чанки.

---

## Ограничения

| Ограничение | Значение |
|-------------|----------|
| `version` | Строго `"1.0"` |
| Допустимые типы материала | `topic_video`, `topic_longread` |
| Массив `chunks` | Не может быть пустым |
| `text` в чанке | Обязательное, не может быть пустой строкой |
| Повторный импорт | Полная замена (delete-before-insert) |
| Авторизация | JWT-токен администратора |

---

## Эндпоинт

```
POST /api/materials/{material_id}/import-chunks
Content-Type: multipart/form-data
Authorization: Bearer {jwt_token}

Body: file (JSON-файл)
```

### Ответ (успех)

```json
{
  "status": "imported",
  "material_id": 4,
  "chunks_created": 5,
  "errors": []
}
```

### Ответ (частичные ошибки)

```json
{
  "status": "imported",
  "material_id": 4,
  "chunks_created": 3,
  "errors": [
    "Материал 4: пустой text в чанке 2"
  ]
}
```

---

## Миграция bz2-video-transcribe

Текущий формат внешней системы и что нужно изменить для совместимости.

### Текущий формат → целевой

| Текущее поле | Действие | Целевое поле |
|-------------|----------|-------------|
| `statistics` | убрать или оставить, BZ2-Bot игнорирует | — |
| — | **добавить** | `version: "1.0"` |
| — | **добавить**, обёртка массивом | `materials: [{ ... }]` |
| — | **добавить**, AI-суммаризация содержимого | `materials[].description` |
| — | **добавить**, краткое описание темы | `materials[].short_description` |
| `metadata` (корень) | **переместить** внутрь materials[0] | `materials[].metadata` |
| `video_id` | **переместить** внутрь metadata | `materials[].metadata.video_id` |
| `chunks` | **переместить** внутрь materials[0] | `materials[].chunks` |
| `chunks[].topic` + `chunks[].text` | **объединить** в новое поле | `chunks[].text` (с контекстной шапкой) |
| `chunks[].id` | **переименовать** | `chunks[].metadata.chunk_id` |
| `chunks[].index` | **переименовать** | `chunks[].metadata.chunk_index` |
| `chunks[].word_count` | **переместить** | `chunks[].metadata.word_count` |
| `chunks[].topic` | **скопировать** (оригинал) | `chunks[].metadata.topic` |

### Псевдокод трансформации

```python
def transform_to_bz2_format(old_json: dict, description: str, short_description: str) -> dict:
    """
    Трансформация из текущего формата bz2-video-transcribe в целевой.

    Args:
        old_json: Текущий JSON внешней системы
        description: Семантический индекс материала (AI-суммаризация содержимого).
        short_description: Краткое описание (1-2 предложения) для Telegram.
    """
    meta = old_json.get("metadata", {})

    # Метаданные материала (из корня)
    material_metadata = {
        "video_id": old_json.get("video_id"),
        "speaker": meta.get("speaker"),
        "event_type": meta.get("event_type"),
        "stream": meta.get("stream"),
        "stream_name": meta.get("stream_name"),
        "date": meta.get("date"),
        "duration_formatted": meta.get("duration_formatted"),
        "whisper_model": meta.get("whisper_model"),
    }

    # Трансформация чанков
    new_chunks = []
    for chunk in old_json.get("chunks", []):
        # Контекстная шапка в тело text
        header_lines = []
        if chunk.get("topic"):
            header_lines.append(f"Тема: {chunk['topic']}")
        if meta.get("speaker"):
            speaker_info = meta["speaker"]
            if meta.get("stream_name"):
                speaker_info += f", {meta['stream_name']}"
            header_lines.append(f"Спикер: {speaker_info}.")
        header = "\n".join(header_lines)
        text = f"{header}\n\n{chunk['text']}" if header else chunk["text"]

        new_chunks.append({
            "text": text,
            "metadata": {
                "chunk_id": chunk.get("id"),
                "chunk_index": chunk.get("index"),
                "topic": chunk.get("topic"),
                "word_count": chunk.get("word_count"),
            },
        })

    return {
        "version": "1.0",
        "materials": [{
            "description": description,
            "short_description": short_description,
            "metadata": material_metadata,
            "chunks": new_chunks,
        }],
    }
```

> **`description` не формируется автоматически из метаданных.** Это семантический индекс, который должен содержать ключевые темы и понятия из содержимого. Рекомендуется генерировать AI-суммаризацией всех чанков.

---

## Доработки BZ2-Bot

Что нужно изменить на нашей стороне для полной поддержки целевого формата.

### 1. Сохранение `metadata` материала при импорте

**Файл:** `src/content/services/indexer.py` → `import_transcript_batch()`

Сейчас `metadata` из `materials[]` не читается. Нужно добавить merge входящих метаданных в `material.metadata_`:

```python
# После обновления description/short_description (строка ~311)
import_metadata = mat_data.get("metadata")
if import_metadata:
    existing = material.metadata_ or {}
    existing.update(import_metadata)
    material.metadata_ = existing
```

### 2. Убрать упрощённый формат из эндпоинта

**Файл:** `src/admin/routers/materials.py` (строки 152-162)

Блок `if "materials" not in data` оборачивает JSON без `materials[]` в стандартный формат. С переходом на целевой контракт — не нужен. Заменить на валидацию:

```python
if "materials" not in data:
    raise HTTPException(
        status_code=400,
        detail='JSON должен содержать ключ "materials"',
    )
```

### 3. Отображение метаданных материала в админке

**Файл:** `admin-portal/src/pages/materials/detail.tsx`

Показать `metadata` материала (спикер, мероприятие, дата) в карточке материала — рядом с секцией чанков. Пока информационный блок без редактирования.

---

## Альтернатива: два поля (text + contextualized_text)

Если внешняя система не может включить контекст в тело `text` (например, нужен оригинальный текст без изменений), поддерживается отдельное поле `contextualized_text`:

```json
{
  "text": "Оригинальный текст транскрипта без изменений...",
  "contextualized_text": "Тема: Закрытие полной оценки.\nСпикер: Иванова А.\n\nОригинальный текст транскрипта без изменений..."
}
```

| Поле | Embedding (поиск) | FTS (keyword) | LLM промпт (ответ) |
|------|:-:|:-:|:-:|
| `text` | да | да | fallback |
| `contextualized_text` | нет | нет | **приоритет** |

`contextualized_text` используется **только** в промпте Claude при генерации ответа. Для поиска (vector + keyword) всегда используется `text`.

**Рекомендация:** включать контекст прямо в `text` — так он влияет на все этапы поиска.

---

_Версия: 1.0 | Обновлено: 9 февраля 2026_
