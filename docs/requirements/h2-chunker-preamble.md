# Обработка преамбулы в H2 chunker

> Корректная обработка текста перед первым ## заголовком при чанкировании

**Статус:** Draft
**Дата:** 2026-02-10
**Версии:** v0.60.x

---

## 1. Проблема

В `h2_chunker.py` есть баг в детекции преамбулы (текст перед первым `## `). Условие на строке 83 никогда не срабатывает — преамбула парсится как обычная секция с мусорным topic.

**Текущая ситуация:**
- Условие `not H2_PATTERN.search(f"## {section}")` всегда False (код сам подставляет `## `)
- Преамбула попадает в ветку `else` → topic = первая строка (часто `---` от frontmatter), content = остаток
- Создаётся мусорный чанк с YAML frontmatter или служебными данными как текстом

**Почему это проблема:**
- В `transcript_chunks.json` появляется лишний чанк с мусорным содержимым (frontmatter, H1 заголовок)
- При импорте в BZ2-Bot мусор попадёт в базу знаний
- Для Story: Obsidian callout с `main_insight` попадает в мусорный чанк
- Реальная преамбула (вводный текст от LLM перед первым H2) теряет осмысленный topic

---

## 2. Решение

Исправить детекцию преамбулы и добавить очистку от служебных данных.

### Ключевые идеи

1. **Детекция преамбулы** — для `i == 0` определять секцию как преамбулу без сломанного regex
2. **Очистка от метаданных** — убрать YAML frontmatter (`---\n...\n---`) и H1 заголовки (`# ...`)
3. **Порог значимости** — если после очистки осталось > 50 символов → создать чанк "Введение"
4. **Пропуск пустых** — если после очистки мало текста → пропустить

---

## 3. Источники преамбулы

### Longread.to_markdown()

```markdown
---
type: "лонгрид"
video_id: "..."
title: "..."
---

# Название лекции

## Вступление
...
```

Преамбула: YAML frontmatter + H1 заголовок. После очистки — пусто. **Пропускаем.**

### Story.to_markdown()

```markdown
---
type: "leadership-story"
names: "..."
---

# История Успеха: Иванов А.

> [!abstract] Главный инсайт
> Текст инсайта...

---

## 1️⃣ Кто они
...
```

Преамбула: YAML frontmatter + H1 + Obsidian callout. После очистки — callout (~100-200 символов). **Открытый вопрос: сохранять как "Введение" или пропускать?**

### Реальный LLM output (наблюдалось в проде)

```markdown
Сегодня поговорим о закрытии полной оценки — моменте, когда
технология проведена, а клиент стоит перед выбором...

## Закрытие полной оценки: как работать с возражениями
...
```

Преамбула: осмысленный вводный текст от LLM. После очистки — полноценный абзац. **Сохраняем как "Введение".**

---

## 7. Ограничения

| Параметр | Лимит | Обоснование |
|----------|-------|-------------|
| Порог значимости | > 50 символов | Отсекает пустые строки и короткие артефакты |
| Topic преамбулы | "Введение" | Единообразный topic для всех преамбул |

---

## 8. План реализации

### Единственный этап (v0.60.x)

- [ ] Добавить `_strip_preamble_metadata(text)` — убирает YAML frontmatter и H1
- [ ] Исправить условие `i == 0` — убрать сломанный `f"## {section}"`
- [ ] Если после очистки > 50 символов → topic "Введение", content = очищенный текст
- [ ] Если мало → skip
- [ ] Обновить Test 10 под новую логику
- [ ] Добавить тесты: frontmatter-only preamble, real text preamble, Story callout preamble

---

## 9. Тестирование

| Сценарий | Ожидаемый результат |
|----------|---------------------|
| Short preamble (`# Title\nShort text.`) | Пропускается, 2 чанка |
| YAML frontmatter + H1 only | Пропускается после очистки |
| Story callout (main_insight) | TBD — зависит от решения |
| Real LLM intro (> 50 chars) | Чанк "Введение" с вводным текстом |
| No preamble (markdown starts with `## `) | Без изменений, как сейчас |

---

## Открытые вопросы

- [ ] Story callout (`> [!abstract]`): сохранять как "Введение" или пропускать? Callout — это main_insight, дублируется ли он в блоках Story?
- [ ] Порог 50 символов — оптимальный? Нужно проверить на реальных примерах
- [ ] Нужно ли очищать Obsidian callout syntax (`> [!abstract]`) при сохранении?
- [ ] Obsidian syntax используется в `schemas.py` в двух `to_markdown()`: `Story` (строка 579, `main_insight`) и `Summary` (строка 834, `essence`). Summary не чанкируется, а вот Story — да. Если callout сохраняется как чанк, нужно ли конвертировать `> [!abstract]` в plain text?
- [ ] Собрать реальные примеры лонгридов с преамбулой из архива на сервере — оценить частоту и содержание
- [ ] Может ли `to_markdown()` не генерировать frontmatter/H1 для целей чанкирования? Или лучше чистить в chunker?

---

## История изменений

| Дата | Версия | Изменения |
|------|--------|-----------|
| 2026-02-10 | 1.0 | Первоначальная версия, описание бага и предложение фикса |

---

_Документ для планирования в Claude Code_
