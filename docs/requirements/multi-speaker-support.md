# Поддержка мультиспикерного контента

> Адаптация промптов, чанков и контекстуализации для MD-транскриптов с несколькими спикерами

**Статус:** Draft
**Дата:** 2026-02-19
**Версии:** v0.65+ (план)
**Зависит от:** [Импорт готовых MD-транскриптов](md-transcript-import.md) (v0.64)

---

## 1. Проблема

Текущие промпты longread, summary и clean предполагают одного спикера:
- Longread: "писать от первого лица, сохранять голос автора"
- Summary: "цитаты спикера" (единственное число), без атрибуции
- Clean: "реплики ведущих → убрать" — но реплики со-спикера не мусор

На мероприятиях регулярно встречаются темы с несколькими спикерами. Pipeline обработает их, но качество результата будет ниже — Claude не получает инструкций, как работать с мультиспикерным контентом.

**Только MD-транскрипты:**
Мультиспикерность реализуема только для готовых MD-транскриптов из MacWhisper, где пользователь подставляет имена спикеров. Whisper API не поддерживает diarization — при транскрибации аудио/видео метки спикеров отсутствуют.

Если на регулярном мероприятии тема с несколькими спикерами — пользователь вручную транскрибирует в MacWhisper, подставляет имена и обрабатывает как MD-транскрипт.

---

## 2. Сценарии

### Сценарий A: Со-спикеры (2 именованных спикера)

Два ведущих ведут одну тему, поочерёдно дополняя друг друга. Каждый может рассказывать свой слайд.

```
Беркин Андрей
Добрый день! Сегодня мы поговорим о том, как строить первое поколение.
Я расскажу про стратегию, а Светлана — про конкретные инструменты.

Дмитрук Светлана
Спасибо, Андрей! Начну с инструмента «солнышко». Это визуальная схема...
```

**Особенности:**
- Единая тема, общая логика изложения
- Спикеры дополняют друг друга
- Лонгрид должен быть цельным, но с атрибуцией идей

### Сценарий B: Линейка (3+ именованных спикеров)

Основной спикер начинает тему, затем приглашает участников на сцену. Каждый рассказывает свою мини-тему. Основной спикер может задавать уточняющие вопросы.

```
Дмитрук Светлана
Сегодня у нас тема «Спонсор, за которым идут». Я пригласила трёх
консультантов из моей команды, которые расскажут свои истории.

Беркин Андрей
Я пришёл в бизнес 3 года назад. Светлана была моим спонсором...

Дмитрук Светлана
Андрей, расскажи, что было самым сложным в первый год?

Беркин Андрей
Самое сложное — это первые 10 встреч. Я боялся звонить...

Иванова Мария
А мой путь начался совсем иначе...
```

**Особенности:**
- Основной спикер задаёт рамку и модерирует
- Приглашённые участники — мини-темы внутри общей
- Уточняющие вопросы ведущего — контекст, не мусор
- Лонгрид должен структурировать по участникам

### Сценарий C: Тема + Q&A (именованные спикеры + SpeakerN)

Основная тема одного-двух спикеров, в конце — ответы на вопросы из зала. Задающие вопросы остаются анонимными (`SpeakerN` — дефолт MacWhisper, имена не подставляются).

```
Дмитрук Светлана
...и это всё о работе с возражениями. Есть вопросы?

Speaker3
А что делать, если клиент говорит «мне не нужно»?

Дмитрук Светлана
Отличный вопрос! В этом случае я обычно...

Speaker5
А если клиент уже пользовался продуктом и разочаровался?

Дмитрук Светлана
Это частый случай. Здесь важно...
```

**Особенности:**
- Основная часть — стандартная тема
- `SpeakerN` — анонимные участники из зала (дефолт MacWhisper)
- Лонгрид выделяет Q&A в отдельный раздел

---

## 3. Решение

### Программное определение сценария

Тип мультиспикерского контента определяется по анализу MD-файла:

1. **Извлечь уникальных спикеров** — строки-метки (`Фамилия Имя` или `SpeakerN`)
2. **Разделить на именованных и анонимных** — `SpeakerN` = анонимный
3. **Определить сценарий:**

| Именованных спикеров | Есть SpeakerN | Сценарий |
|----------------------|---------------|----------|
| 1 | Нет | Односпикерный (текущий pipeline) |
| 1 | Да | **C: Тема + Q&A** |
| 2 | Нет | **A: Со-спикеры** |
| 2 | Да | **A: Со-спикеры + Q&A** |
| 3+ | Нет | **B: Линейка** |
| 3+ | Да | **B: Линейка + Q&A** |

### Передача в промпт

Информация о мультиспикерности передаётся в промпт как часть метаданных:

```
Тип: мультиспикер / со-спикеры
Спикеры: Дмитрук Светлана, Беркин Андрей
Анонимные участники: Speaker3, Speaker5 (вопросы из зала)
```

Claude получает конкретные инструкции для определённого сценария, а не пытается угадать формат.

### Ключевые идеи

1. **Программное определение** — сценарий определяется кодом из содержимого MD-файла, не Claude
2. **Контекст в промпте** — список спикеров и тип сценария передаются явно
3. **Условные инструкции** — промпты содержат секции для каждого сценария
4. **Изменения в промптах + минимальный код** — парсинг спикеров и формирование контекста

---

## 4. Изменения в промптах

### 4.1 Clean (`config/prompts/cleaning/system.md`)

**Текущая проблема:**
- "Реплики ведущих → убрать" — может удалить реплики со-спикера

**Изменения:**
- Уточнить: убирать реплики **организаторов** (объявления, техника), НЕ со-спикеров темы
- Сохранять метки спикеров (имена на отдельных строках) — они нужны для последующих этапов
- Уточняющие вопросы ведущего к участникам линейки — сохранять как контекст
- `SpeakerN` — сохранять как есть

### 4.2 Longread (`config/prompts/longread/`)

**Текущая проблема:**
- "Голос автора — от первого лица" — не работает для нескольких спикеров

**Изменения в `instructions.md`:**

Добавить секцию "Мультиспикерный контент":

| Сценарий | Стратегия лонгрида |
|----------|-------------------|
| **Со-спикеры** | Единый текст от третьего лица, атрибуция через "по словам {Имя}" или "как отметил(а) {Имя}". Логика изложения — общая |
| **Линейка** | Вступление ведущего → отдельный раздел (H2) для каждого участника. Уточняющие вопросы ведущего вплетаются в текст участника |
| **+ Q&A** | Дополнительный раздел "Вопросы и ответы" в конце. `SpeakerN` → "Участник из зала" |

Для линейки — каждый участник получает свой H2-раздел:
```markdown
## Введение (Дмитрук Светлана)

Сегодня мы поговорим о спонсорстве...

## Путь в бизнес (Беркин Андрей)

Я пришёл в бизнес 3 года назад...

## Первые шаги (Иванова Мария)

Мой опыт начался с того, что...

## Вопросы и ответы

**Вопрос:** Что делать, если клиент говорит «мне не нужно»?
**Ответ (Дмитрук С.):** В этом случае...
```

### 4.3 Summary (`config/prompts/summary/instructions.md`)

**Текущая проблема:**
- Цитаты без атрибуции

**Изменения:**
- Цитаты с атрибуцией: `> «Цитата» — Беркин А.`
- Для линейки — мини-конспект каждого участника как подраздел общего конспекта
- Для Q&A — отдельный блок с вопросами и ответами

**Линейка в summary — структура:**
```markdown
## Ключевые мысли

### Беркин Андрей
- Пришёл в бизнес 3 года назад
- Самое сложное — первые 10 встреч
> «Я боялся звонить, но спонсор научил меня...» — Беркин А.

### Иванова Мария
- Начала с онлайн-формата
- Ключ к росту — регулярность
> «Каждый день — одна встреча, без исключений» — Иванова М.
```

### 4.4 Story (`config/prompts/story/`)

**Минимальные изменения:**
- Story уже поддерживает пары (`"names": "Имя1 и Имя2"`)
- Линейка на выездных — это скорее educational (longread), не leadership (story)
- Уточнить: если в leadership-теме два со-спикера — атрибутировать идеи каждому

---

## 5. Изменения в коде

### Парсер спикеров (новый модуль)

```python
# Псевдокод: backend/app/utils/speaker_utils.py

SPEAKER_PATTERN = re.compile(r'^(Speaker\d+|[А-ЯЁA-Z][а-яёa-z]+ [А-ЯЁA-Z][а-яёa-z]+)$')

def parse_speakers(text: str) -> SpeakerInfo:
    """Анализирует текст и определяет спикеров и сценарий."""
    named = set()
    anonymous = set()

    for line in text.splitlines():
        line = line.strip()
        if SPEAKER_PATTERN.match(line):
            if line.startswith("Speaker"):
                anonymous.add(line)
            else:
                named.add(line)

    return SpeakerInfo(
        named_speakers=sorted(named),
        anonymous_speakers=sorted(anonymous),
        scenario=_determine_scenario(len(named), len(anonymous) > 0),
    )

def _determine_scenario(named_count: int, has_anonymous: bool) -> str:
    if named_count <= 1 and not has_anonymous:
        return "single"
    if named_count <= 1 and has_anonymous:
        return "qa"
    if named_count == 2:
        return "co_speakers_qa" if has_anonymous else "co_speakers"
    return "lineup_qa" if has_anonymous else "lineup"
```

### Интеграция в pipeline

Парсинг спикеров выполняется на этапе загрузки MD-файла (TranscribeStage для MD). Результат передаётся в контекст промптов через метаданные.

---

## 6. Чанки и контекстуализация для RAG

Мультиспикерные темы загружаются в RAG базу знаний (BZ2-Bot). Шапка чанка и структура должны адаптироваться под сценарий.

### Текущий формат шапки (односпикерный)

```
Тема: Закрытие полной оценки
Спикер: Иванова А. | ПШ — Супервайзеры | 22.01.2026

## Подготовка к встрече

{текст}
```

### Со-спикеры — адаптация шапки

Два спикера в шапке, единый текст:

```
Тема: Как строить первое поколение
Спикеры: Беркин А., Дмитрук С. | ФСТ | 02.2026

## Инструмент «солнышко»

По словам Светланы, солнышко — это визуальная схема...
```

Чанки формируются по H2 как обычно. Оба имени в шапке попадают в embedding.

### Линейка — адаптация шапки и структуры

Каждый участник получает H2-раздел в лонгриде. Chunker разбивает по H2 автоматически. Шапка адаптируется для каждого чанка:

```
Тема: Спонсор, за которым идут
Участник: Беркин Андрей | Линейка, ведущий: Дмитрук С. | ФСТ | 02.2026

## Путь в бизнес (Беркин Андрей)

Я пришёл в бизнес 3 года назад. Светлана была моим спонсором...
```

**Ключевое отличие:** поле `Спикер` заменяется на `Участник` + `ведущий`. Это даёт:
- Поиск по конкретному участнику ("что рассказывал Беркин")
- Связь с ведущим линейки ("кто из команды Дмитрук рассказывал")
- Связь с общей темой ("примеры пути в бизнес")

Если H2-раздел участника превышает 600 слов — разбивается по параграфам как обычно. Возможно использование H3 внутри раздела участника для более гранулярного разбиения.

### Q&A — отдельный чанк

Q&A-раздел формируется как отдельный чанк. `SpeakerN` заменяется на "Участник из зала":

```
Тема: Работа с возражениями
Спикер: Дмитрук С. | ФСТ | 02.2026

## Вопросы и ответы

**Вопрос:** Что делать, если клиент говорит «мне не нужно»?
**Ответ:** В этом случае я обычно...

**Вопрос:** А если клиент уже пользовался продуктом?
**Ответ:** Это частый случай. Здесь важно...
```

### Ценность для RAG

| Запрос пользователя | Что находит | Как контекст помогает |
|---|---|---|
| "Что рассказывал Беркин на ФСТ?" | Чанки с "Беркин" в шапке | Имя участника в embedding |
| "Примеры пути в бизнес" | Чанки линейки по H2 и содержанию | Семантический поиск по тексту |
| "Кто из команды Дмитрук рассказывал истории?" | Чанки с "ведущий: Дмитрук" | Связь участник ↔ ведущий |
| "Как работать с возражениями?" | Основные чанки + Q&A | Обычный семантический поиск |
| "Какие вопросы задавали на теме про возражения?" | Чанк Q&A | H2 "Вопросы и ответы" |

### Изменения в коде чанков

Текущий детерминистический chunker (H2-парсинг) не меняется. Изменения в saver — формирование шапки чанка:

- **Со-спикеры:** `Спикеры: {имя1}, {имя2}` вместо `Спикер: {имя}`
- **Линейка:** `Участник: {имя} | Линейка, ведущий: {ведущий}` — шапка per-chunk, зависит от H2
- **Q&A:** `SpeakerN` → "Участник из зала" при формировании текста чанка

Для линейки saver должен определить, какому участнику принадлежит H2-раздел (по имени в скобках: `## Путь в бизнес (Беркин Андрей)`), и подставить соответствующую шапку.

---

## Ограничения

| Параметр | Лимит | Обоснование |
|----------|-------|-------------|
| Только MD-транскрипты | Whisper не поддерживает diarization | Метки спикеров — только из MacWhisper |
| SpeakerN = анонимный | Дефолт MacWhisper | Пользователь не подставляет имена для вопросов из зала |
| Паттерн имени | `Фамилия Имя` (кириллица/латиница) | Одинаковый формат MacWhisper |
| Diarization | Не реализуется | Внешний инструмент (MacWhisper) |

---

## 7. План реализации

### Этап 1: Парсер спикеров и контекст (v0.65)

- [ ] Создать `backend/app/utils/speaker_utils.py` — парсинг спикеров из текста
- [ ] Интегрировать в TranscribeStage для MD — определение сценария
- [ ] Передавать информацию о спикерах в контекст промптов

### Этап 2: Адаптация промптов (v0.65)

- [ ] Обновить `cleaning/system.md` — правила для мультиспикерного текста
- [ ] Добавить секцию "Мультиспикерный контент" в `longread/instructions.md`
- [ ] Обновить `summary/instructions.md` — мини-конспекты по участникам, атрибуция цитат
- [ ] Обновить `story/instructions.md` — уточнение для со-спикеров

### Этап 3: Чанки и контекстуализация (v0.65)

- [ ] Адаптировать формирование шапки чанка в saver под сценарий
- [ ] Со-спикеры: `Спикеры: {имя1}, {имя2}` в шапке
- [ ] Линейка: `Участник: {имя} | Линейка, ведущий: {ведущий}` — per-chunk шапка
- [ ] Определение участника H2-раздела по имени в скобках заголовка
- [ ] Q&A: замена `SpeakerN` → "Участник из зала" в тексте чанка
- [ ] Проверить разбиение больших H2-разделов линейки (>600 слов, H3 если нужно)

### Этап 4: Тестирование и итерация

- [ ] Тестирование на реальных мультиспикерных транскриптах (все 3 сценария)
- [ ] Проверка embedding-качества для мультиспикерных чанков
- [ ] Анализ качества longread/summary для каждого сценария
- [ ] Корректировка промптов по результатам

---

## 8. Тестирование

| Сценарий | Ожидаемый результат |
|----------|---------------------|
| MD с 1 спикером | Определён как "single", промпты без изменений |
| MD с 2 спикерами | Определён как "co_speakers", атрибуция в лонгриде |
| MD с 4 спикерами | Определён как "lineup", H2-разделы по участникам |
| MD с 1 спикером + SpeakerN | Определён как "qa", раздел Q&A |
| MD с 3 спикерами + SpeakerN | Определён как "lineup_qa" |
| Clean — метки спикеров | Имена сохранены, реплики не удалены |
| Clean — SpeakerN | Сохранён как есть |
| Summary — со-спикеры | Цитаты с атрибуцией |
| Summary — линейка | Мини-конспект по каждому участнику (подразделы) |
| Longread — линейка | H2-раздел для каждого участника |
| Чанк — со-спикеры | Шапка: `Спикеры: Имя1, Имя2` |
| Чанк — линейка | Per-chunk шапка: `Участник: {имя}`, ведущий указан |
| Чанк — Q&A | `SpeakerN` → "Участник из зала", отдельный чанк |
| RAG — поиск по участнику | Находит чанки конкретного участника линейки |

---

## Решённые вопросы

- [x] **Определение сценария** — программно, по количеству именованных спикеров и наличию SpeakerN
- [x] **Источник мультиспикерности** — только MD-транскрипты (MacWhisper с diarization)
- [x] **Анонимные участники** — `SpeakerN` (дефолт MacWhisper, имена не подставляются)
- [x] **Регулярные мероприятия** — при мультиспикерной теме пользователь вручную делает MD-транскрипт
- [x] **Summary для линейки** — мини-конспект по каждому участнику как подраздел общего конспекта
- [x] **Чанки** — адаптация шапки и структуры под сценарий, единый процесс с промптами

## Открытые вопросы

Нет открытых вопросов.

---

## История изменений

| Дата | Версия | Изменения |
|------|--------|-----------|
| 2026-02-19 | 1.0 | Первоначальная версия |
| 2026-02-19 | 1.1 | Уточнение: только MD-транскрипты, программное определение сценария, SpeakerN |
| 2026-02-19 | 1.2 | Добавлены чанки и контекстуализация для RAG, summary для линейки |

---

_Документ для планирования в Claude Code_
