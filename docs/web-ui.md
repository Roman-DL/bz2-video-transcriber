# Web UI — БЗ2 Транскрибатор

Веб-интерфейс для управления транскрипцией видеозаписей.

## Технологии

| Технология | Назначение |
|------------|------------|
| React 18 + TypeScript | Основа UI |
| Vite | Сборка и dev-сервер |
| TanStack Query | Кэширование API запросов |
| Tailwind CSS v4 | Стилизация |
| Axios | HTTP клиент |
| lucide-react | Иконки |

## Dashboard

```
┌─────────────────────────────────────────────────────────────────┐
│  БЗ2 Транскрибатор  v0.1.0           [● Whisper] [● Ollama]     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────┐  ┌─────────────────────────┐   │
│  │  Inbox (3 видео)        [↻] │  │  Архив (12 видео)   [↻] │   │
│  │  ┌─────────────────────────┐│  │  ▼ 2025 (12)            │   │
│  │  │ 📹 Группа поддержки  [▶]││  │    ▼ 01.09 ПШ (2)       │   │
│  │  │ 📹 Работа с возр.    [▶]││  │      📄 SV Тема (Спикер)│   │
│  │  │ 📹 Первые шаги       [▶]││  │      📄 Другая тема     │   │
│  │  └─────────────────────────┘│  │    ▶ 01.08 ВШ (3)       │   │
│  └─────────────────────────────┘  └─────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

Главная страница содержит:
- **Inbox** — список видео для обработки
- **Архив** — иерархия обработанных видео (год → мероприятие → тема)

## Режимы обработки (v0.56+)

При клике на "Обработать" открывается модальное окно. Режим выбирается в настройках.

| Режим | Компонент | Модалка | Описание |
|-------|-----------|---------|----------|
| **Автоматический** | `AutoProcessingCompact` | `md` (448px) | Компактный UI, автовыполнение |
| **Пошаговый** | `StepByStep` | `full` (1100px) | Split view, ручное управление |

### Автоматический режим (v0.56+)

Компактный UI для production использования (~280px высота контента):

- Автоматическое выполнение всех этапов
- Progress bar с ETA
- Вертикальный список шагов с иконками статуса
- Кнопка "Открыть в архиве" при успешном завершении
- Кнопки "Повторить" и "Закрыть" при ошибке

### Пошаговый режим

Предназначен для тестирования промптов, моделей и отладки:

```
┌─────────────────────────────────────────────────────────────────┐
│  Пошаговая обработка: video.mp4                            [×] │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Шаги: [✓]──[✓]──[●]──[○]──[○]──[○]  ← кликабельные галочки    │
│         ↑    ↑    3    4    5    6     для перезапуска         │
│    клик = перезапуск с этого шага                              │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  Шаг 3: Очистка текста                   [Выполнить →]  │    │
│  │  ████████████████░░░░░░░░░░░░░░░░░░ 45%                 │    │
│  │  Очистка текста...                                      │    │
│  │  ─────────────────────────────────────────────────────  │    │
│  │  Настройки:                                             │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │    │
│  │  │ Модель    ▼│ │ system    ▼│ │ user      ▼│       │    │
│  │  └─────────────┘ └─────────────┘ └─────────────┘       │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
│  Результаты:                                                    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  ▼ Метаданные                                           │    │
│  │  Дата: 2025-01-09 | Поток: ПШ.SV | Спикер: Иванова      │    │
│  ├─────────────────────────────────────────────────────────┤    │
│  │  ▼ Сырая транскрипция (45 мин, 1247 сегментов)          │    │
│  │  [00:00:00] Добрый день, коллеги...                     │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

Позволяет:
- Выполнять каждый этап отдельно
- Просматривать результаты между этапами
- **Кликабельные шаги** — клик на галочку перезапускает с этого этапа (сбрасывает последующие результаты)
- **Выбор модели** — для LLM-этапов (clean, longread, summarize, story) можно выбрать модель per-step
- **Выбор промптов** — для этапов с несколькими вариантами показываются селекторы
- **A/B тестирование** — сравнение комбинаций модель+промпты на одном файле

### Автоматический режим

Для production использования:
- Запускает все 6 этапов последовательно
- Показывает только прогресс (без промежуточных результатов)
- Модальное окно незакрываемое до завершения
- После завершения — видео в архиве

## Структура компонентов

```
frontend/src/
├── hooks/               # React hooks (v0.56+)
│   └── usePipelineProcessor.ts  # Shared pipeline logic
├── utils/               # Shared utilities
│   ├── modelUtils.ts    # getDisplayModelName()
│   └── formatUtils.ts   # formatTime(), formatCost()
└── components/
    ├── layout/          # Header, Layout
    ├── common/          # Button, Card, Modal, ProgressBar, Spinner
    ├── services/        # ServiceStatus (Whisper/Claude индикаторы)
    ├── inbox/           # InboxList, VideoItem
    ├── archive/         # ArchiveCatalog
    ├── processing/      # ProcessingModal, StepByStep, AutoProcessingCompact
    ├── slides/          # SlidesAttachment, SlidesModal
    ├── settings/        # SettingsModal, ModelSelector, ComponentPromptSelector
    └── results/         # MetadataView, TranscriptView, ChunksView, SummaryView...
```

### usePipelineProcessor Hook (v0.56+)

Общий хук для логики обработки. Используется обоими компонентами (`AutoProcessingCompact` и `StepByStep`).

**Ответственности:**
- Инициализация всех step hooks
- State management (currentStep, data, error)
- Динамическое определение pipeline steps
- Auto-run логика (для автоматического режима)
- Progress tracking (progress, estimatedSeconds, elapsedSeconds)
- Prompt и model overrides (для пошагового режима)

**Подробнее:** [architecture.md#frontend-processing-architecture](architecture.md#frontend-processing-architecture-v056)

## API интеграция

### Hooks (TanStack Query)

| Hook | Назначение |
|------|------------|
| `useInbox` | Список видео в inbox (polling 30s) |
| `useArchive` | Дерево папок архива (polling 30s) |
| `useServices` | Статус AI сервисов |
| `useSteps` | Пошаговый режим с SSE прогрессом |

### SSE (Server-Sent Events)

Прогресс обработки в реальном времени через SSE:

```typescript
// Формат сообщений
{ type: "progress", status: "transcribing", progress: 45.5, message: "..." }
{ type: "result", data: { ... } }
{ type: "error", error: "..." }
```

## Разработка

### Локальный запуск

```bash
cd frontend
npm install
npm run dev
```

Dev-сервер запускается на http://localhost:5173 с proxy на backend (через Tailscale):

```typescript
// vite.config.ts
export default defineConfig({
  server: {
    proxy: {
      '/api': {
        target: 'http://100.64.0.1:8801',
        changeOrigin: true
      },
      '/health': {
        target: 'http://100.64.0.1:8801',
        changeOrigin: true
      }
    }
  }
})
```

### Production сборка

```bash
npm run build
```

Собранные файлы раздаются через nginx (см. [deployment.md](deployment.md)).

## Связанные документы

- [architecture.md](architecture.md) — техническая архитектура
- [pipeline/](pipeline/) — детальный pipeline
- [deployment.md](deployment.md) — развёртывание
