---
doc_type: reference
ai_scope: none
status: active
created: 2026-01-24
updated: 2026-01-24
tags:
  - documentation
  - meta
  - agent
---

# Agent: arch-checker

> Проверяет соответствие новых фич существующим ADR и архитектурным решениям.

---

## Назначение

**arch-checker** анализирует предлагаемую фичу или изменение и проверяет:
1. Соответствует ли существующим ADR
2. Не нарушает ли установленные архитектурные паттерны
3. Требуется ли новый ADR

**Когда использовать:**
- Перед началом реализации новой фичи
- При рефакторинге существующих модулей
- При изменении API контракта
- При добавлении новых зависимостей

---

## Матрица ADR

### По областям

| Область | Релевантные ADR | Ключевые ограничения |
|---------|-----------------|----------------------|
| **Pipeline stages** | [001](../../adr/001-stage-abstraction.md), [002](../../adr/002-pipeline-decomposition.md) | BaseStage, StageContext, StageRegistry |
| **AI интеграция** | [004](../../adr/004-ai-client-abstraction.md), [006](../../adr/006-cloud-model-integration.md), [007](../../adr/007-remove-fallback-use-claude.md) | BaseAIClient, Context Profiles, Claude по умолчанию |
| **Кэширование** | [005](../../adr/005-result-caching.md) | Версионирование, StageCache |
| **Промпты** | [008](../../adr/008-external-prompts.md) | Внешние файлы, приоритет загрузки |
| **Метрики** | [009](../../adr/009-extended-metrics.md) | ChatUsage, стоимость, время |
| **API** | [013](../../adr/013-api-camelcase-serialization.md) | CamelCase в JSON, snake_case в Python |
| **UI режимы** | [011](../../adr/011-processing-mode-separation.md) | Auto vs Step-by-Step разделение |
| **Слайды** | [010](../../adr/010-slides-integration.md) | Vision API, опциональный этап |
| **Утилиты** | [003](../../adr/003-shared-utils.md) | extract_json, estimate_tokens в utils/ |

### По типам изменений

| Тип изменения | ADR для проверки | Вопросы |
|---------------|------------------|---------|
| Новый stage pipeline | 001, 002, 005 | Наследует BaseStage? Регистрируется в StageRegistry? |
| Новый AI провайдер | 004, 006 | Реализует BaseAIClient? Есть Context Profiles? |
| Изменение API | 013 | CamelCase сериализация? CamelCaseModel? |
| Новый формат вывода | 009, 005 | Метрики? Кэширование? |
| Изменение промптов | 008 | Внешний файл? Приоритет загрузки? |
| UI компонент | 011 | Какой режим? Auto или Step-by-Step? |

---

## Использование

### Вариант 1: Проверка перед реализацией

```
Проверь архитектурное соответствие предлагаемой фичи.

## Фича
{описание фичи}

## Контекст
Используй docs/meta/agents/arch-checker.md

## Задача
1. Определи затрагиваемые области (pipeline, API, AI, UI...)
2. Найди релевантные ADR по матрице
3. Проверь соответствие каждому ADR
4. Если есть нарушения — предложи как исправить
5. Если нужен новый ADR — укажи почему
```

### Вариант 2: Ревью существующего кода

```
Проверь соответствие кода архитектурным решениям.

## Файлы
{список файлов для проверки}

## Контекст
Используй docs/meta/agents/arch-checker.md

## Задача
1. Прочитай код
2. Определи какие ADR затрагивает
3. Проверь соответствие паттернам
4. Выведи список нарушений (если есть)
```

### Вариант 3: Нужен ли новый ADR?

```
Определи, требуется ли новый ADR для предлагаемого изменения.

## Изменение
{описание}

## Критерии (из framework.md)
ADR нужен если:
- Архитектурно значимое решение
- Влияет на несколько модулей
- Меняет установленные паттерны
- Имеет долгосрочные последствия

## Задача
Оцени по критериям и дай рекомендацию
```

---

## Чеклисты по областям

### ✅ Новый Pipeline Stage

```markdown
## Checklist: New Pipeline Stage

### ADR-001: Stage Abstraction
- [ ] Класс наследует `BaseStage`
- [ ] Определён `name: str`
- [ ] Определён `depends_on: list[str]`
- [ ] Реализован `async def execute(context: StageContext) -> Result`
- [ ] Реализован `def should_skip(context: StageContext) -> bool` (если опциональный)

### ADR-002: Pipeline Decomposition
- [ ] Stage зарегистрирован в `stages/__init__.py`
- [ ] Добавлен weight в `progress_manager.py`
- [ ] Обновлён `DEFAULT_PIPELINE_STAGES` (если не опциональный)

### ADR-005: Result Caching
- [ ] Результат сериализуется в JSON
- [ ] Определена версия для кэширования
- [ ] StageCache учитывает новый stage

### ADR-008: External Prompts
- [ ] Промпты в `config/prompts/{stage_name}/`
- [ ] Используется `PromptLoader` для загрузки
- [ ] Есть default промпт

### ADR-009: Extended Metrics
- [ ] Результат содержит `usage: ChatUsage` (если использует LLM)
- [ ] Возвращается `processing_time_ms`
```

### ✅ Новый AI Client

```markdown
## Checklist: New AI Client

### ADR-004: AI Client Abstraction
- [ ] Реализует `BaseAIClient` Protocol
- [ ] Метод `async def generate(messages, model_config) -> tuple[str, ChatUsage]`
- [ ] Поддержка `context_profile` из `models.yaml`
- [ ] Корректный подсчёт токенов

### ADR-006: Cloud Model Integration
- [ ] Конфигурация в `config/models.yaml`
- [ ] Указан `provider`, `pricing`, `context_profiles`
- [ ] Добавлен в `ProcessingStrategy.create_client()`

### ADR-007: No Fallback
- [ ] НЕ реализует fallback между провайдерами
- [ ] Явная ошибка при недоступности
```

### ✅ Новый API Endpoint

```markdown
## Checklist: New API Endpoint

### ADR-013: CamelCase Serialization
- [ ] Response модель наследует `CamelCaseModel`
- [ ] Request принимает camelCase поля
- [ ] Python код использует snake_case внутри
- [ ] Pydantic `alias_generator` настроен

### Документация
- [ ] Добавлен в `docs/api-reference.md`
- [ ] Добавлен в `docs/pipeline/09-api.md` (если pipeline-related)
- [ ] TypeScript типы в `frontend/src/api/types.ts`
```

### ✅ Изменение промптов

```markdown
## Checklist: Prompt Changes

### ADR-008: External Prompts
- [ ] Промпт в файле `config/prompts/{stage}/{variant}.md`
- [ ] Приоритет загрузки: PROMPTS_DIR → config/prompts/ → embedded
- [ ] Если новый вариант — доступен через `/api/prompts/{stage}`
- [ ] Документация в `docs/pipeline/{stage}.md`
```

---

## Алгоритм работы

```
┌─────────────────────────────────────────────────────┐
│                   arch-checker                       │
├─────────────────────────────────────────────────────┤
│                                                      │
│  INPUT: Описание фичи / Файлы кода                  │
│     │                                                │
│     ▼                                                │
│  ┌─────────────────────────────────────────────┐    │
│  │ 1. Определить затрагиваемые области         │    │
│  │    - Pipeline? AI? API? UI? Config?         │    │
│  └─────────────────────────────────────────────┘    │
│     │                                                │
│     ▼                                                │
│  ┌─────────────────────────────────────────────┐    │
│  │ 2. Найти релевантные ADR                    │    │
│  │    Использовать матрицу выше                │    │
│  └─────────────────────────────────────────────┘    │
│     │                                                │
│     ▼                                                │
│  ┌─────────────────────────────────────────────┐    │
│  │ 3. Применить чеклисты                       │    │
│  │    Для каждой области — свой чеклист        │    │
│  └─────────────────────────────────────────────┘    │
│     │                                                │
│     ▼                                                │
│  ┌─────────────────────────────────────────────┐    │
│  │ 4. Выявить нарушения                        │    │
│  │    Несоответствия ADR и паттернам           │    │
│  └─────────────────────────────────────────────┘    │
│     │                                                │
│     ▼                                                │
│  ┌─────────────────────────────────────────────┐    │
│  │ 5. Оценить необходимость нового ADR         │    │
│  │    По критериям из framework.md             │    │
│  └─────────────────────────────────────────────┘    │
│     │                                                │
│     ▼                                                │
│  OUTPUT: Отчёт с нарушениями и рекомендациями       │
│                                                      │
└─────────────────────────────────────────────────────┘
```

---

## Критерии для нового ADR

Новый ADR **нужен** если:

| Критерий | Примеры |
|----------|---------|
| Архитектурно значимо | Новый паттерн, новая абстракция |
| Затрагивает несколько модулей | Изменение в 3+ компонентах |
| Меняет существующие решения | Отход от ADR-007 (возврат fallback) |
| Долгосрочные последствия | Выбор базы данных, протокола |
| Есть несколько альтернатив | Нужно зафиксировать "почему так" |

Новый ADR **не нужен** если:

| Критерий | Примеры |
|----------|---------|
| Локальное изменение | Рефакторинг одного модуля |
| Следует существующим паттернам | Новый stage по ADR-001 |
| Исправление багов | Фикс без архитектурных изменений |
| UI/UX изменения | Новый компонент по существующим паттернам |

---

## Примеры результатов

### Пример 1: Новый stage "translate"

**Input:**
```
Хочу добавить этап translate для перевода контента на английский.
Будет использовать Claude API.
```

**Output:**
```
## Архитектурный анализ: stage "translate"

### Затрагиваемые области
- Pipeline stages
- AI интеграция

### Релевантные ADR
- ADR-001: Stage Abstraction ✅
- ADR-002: Pipeline Decomposition ✅
- ADR-004: AI Client Abstraction ✅
- ADR-005: Result Caching ✅
- ADR-007: No Fallback ✅
- ADR-008: External Prompts ✅
- ADR-009: Extended Metrics ✅

### Чеклист

#### ADR-001
- [ ] Создать `translate_stage.py` с классом `TranslateStage(BaseStage)`
- [ ] `name = "translate"`
- [ ] `depends_on = ["clean"]` или `["longread"]`

#### ADR-002
- [ ] Зарегистрировать в `stages/__init__.py`
- [ ] Добавить weight в `progress_manager.py`

#### ADR-008
- [ ] Создать `config/prompts/translate/system.md`

#### ADR-009
- [ ] TranslateResult должен содержать ChatUsage

### Нужен ли новый ADR?
**Нет** — следует существующим паттернам ADR-001.

### Рекомендации
1. Определить: опциональный или обязательный этап?
2. Решить: после какого этапа выполнять?
3. Добавить документацию в `docs/pipeline/`
```

### Пример 2: Добавление fallback на Ollama

**Input:**
```
Хочу добавить fallback на Ollama если Claude API недоступен.
```

**Output:**
```
## Архитектурный анализ: Ollama fallback

### ⚠️ НАРУШЕНИЕ ADR-007

**ADR-007: Remove Fallback, Use Claude** явно запрещает fallback между провайдерами.

### Цитата из ADR-007:
> "Решено: Удалить fallback логику. Claude как единственный провайдер.
> Причина: Разное качество провайдеров создаёт непредсказуемые результаты."

### Варианты решения

1. **Отказаться от fallback** (рекомендуется)
   - Следовать ADR-007
   - Улучшить обработку ошибок Claude API

2. **Создать ADR-014: Reinstate Fallback**
   - Обосновать необходимость
   - Описать новую стратегию
   - ADR-007 получит статус `superseded`

### Рекомендация
Если fallback критически нужен — создайте ADR-014 с обоснованием.
Иначе — реализуйте retry с exponential backoff для Claude API.
```

---

## Интеграция

### В CLAUDE.md

```markdown
## Перед реализацией новой фичи

Запусти arch-checker для проверки соответствия архитектуре:

\`\`\`
Используй docs/meta/agents/arch-checker.md для проверки:
{описание фичи}
\`\`\`

Особенно важно для:
- Новых pipeline stages
- Изменений в API
- Новых AI интеграций
```

### В процессе code review

```markdown
## Чеклист ревьюера

- [ ] Запущен arch-checker для изменений
- [ ] Нет нарушений существующих ADR
- [ ] Если нужен новый ADR — создан draft
```

---

## Связанные документы

- [Diátaxis+ Framework](../framework.md) — когда нужен ADR
- [Architecture Summary](../../audit/architecture-summary.md) — карта компонентов
- [ADR Index](../../adr/) — все архитектурные решения
- [doc-sync](doc-sync.md) — синхронизация документации

---

## Changelog

| Дата | Изменение |
|------|-----------|
| 2026-01-24 | Создан документ |
