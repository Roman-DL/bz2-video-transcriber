# RFC: Тестирование модели qwen3:14b для pipeline транскрипции

## Статус
- [x] Планирование
- [x] Тестирование cleaner (раунд 1 — с таймкодами)
- [x] Тестирование chunker (раунд 1 — неинформативен)
- [x] Тестирование summarizer (раунд 1 — неинформативен)
- [x] Анализ результатов раунда 1
- [x] **Раунд 2: тестирование без таймкодов**
- [x] **Раунд 3: исправленная позиция /no_think + pipeline режим**
- [x] Финальное решение
- [ ] Архивация RFC

## Цель

Оценить qwen3:14b с режимом `/no_think` для задач очистки, чанкирования и суммаризации транскриптов. Определить оптимальную модель для каждого шага pipeline.

## Контекст

- **Текущие модели:** gemma2:9b (cleaner/chunker), qwen2.5:14b (summarizer)
- **Проблема:** qwen2.5 склонна к суммаризации при очистке (50-60% compression)
- **Гипотеза:** `/no_think` в qwen3 решит проблему — модель будет выполнять инструкцию без попыток "улучшить" текст

## Характеристики моделей

| Модель | Контекст | Особенности |
|--------|----------|-------------|
| gemma2:9b | 8K токенов | Стабильна, хорошо следует инструкциям |
| qwen2.5:14b | 32K токенов | Склонна к суммаризации |
| qwen3:14b | 40K токенов | `/no_think` отключает "размышления" |

## Критерии успеха

| Шаг | Метрика | Целевое значение |
|-----|---------|------------------|
| Cleaner | compression | 15-30% |
| Cleaner | cyrillic_ratio | >90% |
| Cleaner | сохранение предложений | >85% |
| Chunker | normal_ratio (100-400 слов) | >80% |
| Chunker | JSON validity | 100% |
| Chunker | chunks count | 10-20 для ~3000 слов |

## Тестовые данные

Используется готовый транскрипт из предыдущего прогона:
- **Путь в контейнере:** `/data/archive/2025/12.22 ПШ/SV Закрытие ПО, возражения (Кухаренко Женя)/transcript_raw.txt`
- **Видео:** 55 минут, ~8900 слов после очистки

---

## Результаты тестирования

### Cleaner

| Модель | NoThink | Compression | Cyrillic | Sentences | Time | Комментарий |
|--------|---------|-------------|----------|-----------|------|-------------|
| gemma2:9b (baseline) | - | 4.6% | 53% | 103% | 55.7s | **Рекомендуется** — быстрый, стабильный |
| qwen3:14b | No | 1.8% | 52% | 104% | 360.5s | Выдаёт English summary на некоторых чанках |
| qwen3:14b | Yes | 2.0% | 52% | 103% | 389.0s | /no_think **НЕ решает** проблему суммаризации |

**Примечание:** Cyrillic ~52% объясняется таймстампами `[00:XX:XX]` в сыром транскрипте.

**Вывод для Cleaner:** qwen3:14b с /no_think не подходит — всё равно генерирует английские summary.
gemma2:9b остаётся лучшим выбором (6-7x быстрее, стабильнее).

### Chunker

| Модель | NoThink | Success | Chunks | Avg Size | Normal% | Score | Комментарий |
|--------|---------|---------|--------|----------|---------|-------|-------------|
| gemma2:9b (baseline) | - | 0% | - | - | - | 0.00 | Invalid JSON |
| qwen3:14b | No | 0% | - | - | - | 0.00 | Invalid JSON |
| qwen3:14b | Yes | 0% | - | - | - | 0.00 | Expected JSON array |

**Примечание:** Все модели провалили тест на длинном транскрипте (~69K chars после очистки).
Проблема: cleaner генерирует английский текст на некоторых чанках (cyrillic=0%), что ломает chunker.

**Вывод для Chunker:** Тест неинформативен из-за проблем с cleaner на этих данных.
Требуется повторный тест на более коротком/чистом транскрипте.

### Summarizer

| Модель | NoThink | Success | JSON | Summary | KeyPts | Tags | Time | Комментарий |
|--------|---------|---------|------|---------|--------|------|------|-------------|
| qwen2.5:14b (baseline) | - | 0% | 0% | - | - | - | - | Invalid JSON |
| qwen3:14b | No | 0% | 0% | - | - | - | - | Invalid JSON |
| qwen3:14b | Yes | 0% | 0% | - | - | - | - | Invalid JSON |

**Примечание:** Все модели провалили тест - текст после очистки слишком длинный (~69K chars).
В реальном pipeline summarizer получает outline (~1K tokens), а не полный текст.

**Вывод для Summarizer:** Тест неинформативен. Требуется тестирование с реальным outline.

---

## Решение

**qwen3:14b с /no_think НЕ рекомендуется** для данного pipeline.

### Причины (подтверждено в 3 раундах тестирования):
1. **`/no_think` не работает:** разница времени ~5% вместо ожидаемых 30-50%
2. **Cleaner:** генерирует "Анализ текста" вместо очистки на сложных фрагментах
3. **Chunker:** не генерирует валидный JSON (0% success rate)
4. **Скорость:** 4x медленнее gemma2:9b (256s vs 61s для cleaner)

### Текущая конфигурация остаётся оптимальной:
| Задача | Модель | Обоснование |
|--------|--------|-------------|
| Cleaner | gemma2:9b | 4x быстрее, стабильный, хорошо следует инструкциям |
| Chunker | gemma2:9b | Единственная с валидным JSON output |
| Summarizer | qwen2.5:14b | Большой контекст, качественные тексты |

### RFC завершён
- ~~Раунд 1: с таймкодами~~
- ~~Раунд 2: без таймкодов~~
- ~~Раунд 3: /no_think в начале + pipeline режим~~
- **Вывод:** qwen3:14b не подходит для данного pipeline

---

## Раунд 2: Улучшенная методика тестирования

### Выявленные проблемы раунда 1

1. **Таймкоды мешают LLM** — модели (особенно qwen) плохо работают с `[00:XX:XX]` в тексте
2. **Память ollama** — при переключении моделей первая не сразу выгружается, вторая работает медленнее
3. **Последовательность этапов** — cleaner → chunker → summarizer должны тестироваться последовательно для каждой модели

### Изменения в скрипте

```bash
# Теперь по умолчанию таймкоды удаляются
python3 test_models_comprehensive.py --stage cleaner --runs 1

# Для сравнения — с таймкодами
python3 test_models_comprehensive.py --stage cleaner --runs 1 --no-strip-timestamps
```

**Функция `strip_timestamps()`** удаляет:
- `[HH:MM:SS]` и `[MM:SS]` паттерны
- Лишние пробелы и пустые строки

**Ожидаемый эффект:**
- Cyrillic ratio вырастет с ~52% до >90%
- qwen3 перестанет генерировать английские summary

### План раунда 2

| Шаг | Команда |
|-----|---------|
| 1. Cleaner без таймкодов | `--stage cleaner --runs 1` |
| 2. Chunker (если cleaner OK) | `--stage chunker --runs 1` |
| 3. Summarizer (если chunker OK) | `--stage summarizer --runs 1` |

### Результаты раунда 2

#### Cleaner (без таймкодов)

| Модель | NoThink | Compression | Cyrillic | Sentences | Time | Комментарий |
|--------|---------|-------------|----------|-----------|------|-------------|
| gemma2:9b | - | -0.4% | 78% | 102% | 57s | **Рекомендуется** — быстрый, валидация отлавливает плохие чанки |
| qwen3:14b | No | 0.5% | 78% | 101% | 254s | Генерирует "анализ" на сложных чанках |
| qwen3:14b | Yes | 0.3% | 78% | 101% | 233s | /no_think не помогает — тоже генерирует "анализ" |

**Примечание:** Cyrillic ratio 78% (vs 52% с таймкодами) — значительное улучшение!
Валидация успешно отбрасывает плохие чанки и использует оригинальный текст.

#### Chunker (без таймкодов)

| Модель | NoThink | Success | Chunks | Avg Size | Normal% | Score | Комментарий |
|--------|---------|---------|--------|----------|---------|-------|-------------|
| gemma2:9b | - | 100% | 31 | 264 | 84% | 0.43 | **Рекомендуется** — стабильный JSON |
| qwen3:14b | No | 0% | - | - | - | 0.00 | Invalid JSON |
| qwen3:14b | Yes | 0% | - | - | - | 0.00 | Invalid JSON |

**Вывод:** qwen3:14b не генерирует валидный JSON для chunker.

#### Summarizer (без таймкодов)

| Модель | NoThink | Success | JSON | Summary | KeyPts | Tags | Time | Комментарий |
|--------|---------|---------|------|---------|--------|------|------|-------------|
| qwen2.5:14b | - | 0% | 0% | - | - | - | - | Invalid JSON (текст слишком длинный) |
| qwen3:14b | No | 0% | 0% | - | - | - | - | Invalid JSON |
| qwen3:14b | Yes | 0% | 0% | - | - | - | - | Invalid JSON |

**Примечание:** Тест нерелевантен — summarizer получает полный текст (~47K chars),
а в реальном pipeline получает outline (~1K tokens). Требуется отдельный тест с outline.

---

## Раунд 3: Исправленная методика

### Выявленные проблемы раундов 1-2

1. **`/no_think` добавлялся в КОНЕЦ запроса** — неправильно! Должен быть в НАЧАЛЕ
2. **Разница времени think/no_think ~8%** — слишком мало, должно быть 30-50%
3. **qwen3 обрабатывал вывод gemma2** — нечестное сравнение для chunker/summarizer

### Изменения в раунде 3

1. **`/no_think` теперь в НАЧАЛЕ user message:**
   ```python
   # Было (неправильно):
   cleaner.user_template = cleaner.user_template + "\n/no_think"

   # Стало (правильно):
   cleaner.user_template = "/no_think\n" + cleaner.user_template
   ```

2. **Pipeline режим** — каждая модель проходит полную цепочку:
   ```
   gemma2:9b:  cleaner → chunker → summarizer (свой output)
   qwen3:14b:  cleaner → chunker → summarizer (свой output)
   ```

### Команда запуска

```bash
python3 test_models_comprehensive.py --mode pipeline --runs 1
```

### Результаты раунда 3

#### Pipeline результаты

| Model | NoThink | Clean | Chunk | Summ | Total Time | Комментарий |
|-------|---------|-------|-------|------|------------|-------------|
| gemma2:9b | - | ✓ (61s) | ✓ (188s) | ✗ (5s) | 254s | **Единственная с валидным JSON chunker** |
| qwen3:14b | No | ✓ (256s) | ✗ | SKIP | 325s | Invalid JSON для chunker |
| qwen3:14b | Yes | ✓ (244s) | ✗ | SKIP | 310s | Invalid JSON для chunker |

#### Детали по этапам

**Cleaner:**
| Model | NoThink | Compress | Cyrillic | Time |
|-------|---------|----------|----------|------|
| gemma2:9b | - | -0.4% | 78% | 60.7s |
| qwen3:14b | No | 0.5% | 78% | 256.2s |
| qwen3:14b | Yes | 0.4% | 78% | 243.9s |

**Chunker:**
| Model | NoThink | Success | Chunks | Avg | Normal% |
|-------|---------|---------|--------|-----|---------|
| gemma2:9b | - | ✓ | 33 | 251w | 73% |
| qwen3:14b | No | ✗ | - | - | - |
| qwen3:14b | Yes | ✗ | - | - | - |

**Summarizer:**
- gemma2:9b: FAIL (Invalid JSON despite valid chunker output)
- qwen3:14b: SKIPPED (chunker failed)

### Выводы раунда 3

1. **`/no_think` НЕ работает:**
   - Разница времени 256s vs 244s = **5%** (ожидалось 30-50%)
   - qwen3 всё ещё генерирует "Анализ текста" вместо очистки

2. **qwen3:14b не генерирует валидный JSON:**
   - Chunker падает с "Invalid JSON" или "Extra data"
   - Модель не следует JSON формату даже с `/no_think`

3. **gemma2:9b стабильнее:**
   - Cleaner: 4x быстрее (61s vs 256s)
   - Chunker: единственная с валидным JSON
   - Summarizer: тоже падает — требует исследования

4. **Summarizer требует отдельного исследования:**
   - Падает даже на gemma2:9b с валидным chunker output
   - Возможно проблема в промпте или длине входных данных

---

## Затрагиваемые файлы

После успешных тестов обновить:
- `backend/app/config.py` — модели по умолчанию
- `docs/model-testing.md` — результаты тестирования
- `CLAUDE.md` — таблица моделей

---

## История изменений

| Дата | Изменение |
|------|-----------|
| 2026-01-12 | RFC создан, начало тестирования |
| 2026-01-12 | Раунд 1: Cleaner тесты — qwen3:14b не подходит (с таймкодами) |
| 2026-01-12 | Раунд 1: Chunker/Summarizer тесты — неинформативны (длинные данные) |
| 2026-01-12 | Раунд 2: Улучшенная методика — удаление таймкодов из транскрипта |
| 2026-01-12 | Раунд 2: Cleaner/Chunker/Summarizer тесты — qwen3:14b не подходит |
| 2026-01-12 | Раунд 3: Исправлена позиция /no_think, добавлен pipeline режим |
| 2026-01-12 | Раунд 3 завершён: /no_think не работает (5% разница), JSON invalid |
| 2026-01-12 | **RFC завершён** — текущая конфигурация оптимальна |
