# БЗ Транскрибатор v2 — Требования к доработке

> **Референс-компонент:** `SettingsModal-reference.jsx`
> **Дата:** 2026-01-22
> **Статус:** ✅ Реализовано (v0.42—v0.46)

---

## 0. Анализ текущей реализации (по скриншотам)

### 0.1 Метаданные
**Текущее состояние:** ✓ Хорошо
- Показаны все нужные поля
- Длительность отображается (5:01)
- **Замечание:** Можно улучшить визуальное оформление (сетка 2 колонки)

### 0.2 Транскрипт (Сырая транскрипция)
**Текущее состояние:** ⚠️ Требует доработки

| Метрика | Сейчас | Нужно |
|---------|--------|-------|
| Длительность | ✓ 5:01 | ✓ Оставить |
| Сегменты | ✓ 84 сегментов | ✗ **Убрать** |
| Модель | ✓ large-v3-turbo | ✓ Оставить |
| Язык | ✗ | ✓ **Добавить** |
| Символы | ✗ | ✓ **Добавить** |
| Слова | ✗ | ✓ **Добавить** |
| Confidence | ✗ | ✓ **Добавить** |
| Время обработки | ✗ | ✓ **Добавить** |

### 0.3 Очистка (Очищенная транскрипция)
**Текущее состояние:** ⚠️ Требует доработки

| Метрика | Сейчас | Нужно |
|---------|--------|-------|
| Символы | ✓ 4 187 симв. | ✓ Оставить |
| % изменения | ✓ -5% | ✓ Оставить |
| Модель | ✓ claude-sonnet-4-5 | ✓ Оставить |
| Слова | ✗ | ✓ **Добавить** |
| Токены (вх/вых) | ✗ | ✓ **Добавить** |
| Стоимость | ✗ | ✓ **Добавить** |
| Время обработки | ✗ | ✓ **Добавить** |
| Diff View | ✗ | ✓ **Добавить кнопку** |

**Панель настроек:** ✓ Есть (system/user промпты) — соответствует требованиям

### 0.4 Лонгрид
**Текущее состояние:** ⚠️ Требует доработки

| Метрика | Сейчас | Нужно |
|---------|--------|-------|
| Секции | ✓ 1 секция | ✗ **Убрать** |
| Слова | ✓ 626 слов | ✓ Оставить |
| Модель | ✓ claude-sonnet-4-5 | ✓ Оставить |
| Символы | ✗ | ✓ **Добавить** |
| % изменения | ✗ | ✓ **Добавить** |
| Токены (вх/вых) | ✗ | ✓ **Добавить** |
| Стоимость | ✗ | ✓ **Добавить** |
| Время обработки | ✗ | ✓ **Добавить** |
| Diff View | ✗ | ✓ **Добавить кнопку** |

### 0.5 Конспект
**Текущее состояние:** ⚠️ Требует доработки

| Метрика | Сейчас | Нужно |
|---------|--------|-------|
| Концепции | ✓ 4 концепции | ✗ **Убрать** |
| Цитаты | ✓ 4 цитат | ✗ **Убрать** |
| Модель | ✓ claude-sonnet-4-5 | ✓ Оставить |
| Символы | ✗ | ✓ **Добавить** |
| Слова | ✗ | ✓ **Добавить** |
| Токены (вх/вых) | ✗ | ✓ **Добавить** |
| Стоимость | ✗ | ✓ **Добавить** |
| Время обработки | ✗ | ✓ **Добавить** |

### 0.6 Чанки
**Текущее состояние:** ⚠️ Требует доработки

| Метрика | Сейчас | Нужно |
|---------|--------|-------|
| Кол-во чанков | ✓ 1 чанков | ✓ Оставить |
| Слов/чанк | ✓ ~513 слов/чанк | ⚠️ Заменить на общие токены |
| Модель | ✓ deterministic | ✓ Оставить |
| Общие токены | ✗ | ✓ **Добавить** |
| Настройки | ✗ | ✓ **Добавить панель настроек** |

### 0.7 Итоги (Успешно сохранено)
**Текущее состояние:** ❌ Требует значительной доработки

| Элемент | Сейчас | Нужно |
|---------|--------|-------|
| Список файлов | ✓ Есть | ✓ Оставить |
| Размеры файлов | ✗ | ✓ **Добавить** |
| Общее время | ✗ | ✓ **Добавить** |
| Токены (вх/вых) | ✗ | ✓ **Добавить** |
| Общая стоимость | ✗ | ✓ **Добавить** |

### 0.8 Общие замечания по UI

| Проблема | Описание | Решение |
|----------|----------|---------|
| Высота контента | Контент не занимает всю высоту | Использовать `flex-1 h-full` |
| Footer с метриками | Отсутствует у LLM-шагов | Добавить footer с токенами и стоимостью |
| Настройки chunk | Нет панели настроек | Добавить `hasSettings: true` |
| Diff View | Функционал отсутствует | Реализовать toggle-режим |

---

## 1. Обзор изменений

### 1.1 Цели доработки
- Упростить интерфейс, убрав избыточные метрики
- Добавить полезные метрики для отладки промптов
- Реализовать функцию сравнения текстов (Diff View)
- Добавить расчёт стоимости обработки
- Унифицировать отображение времени

### 1.2 Затронутые компоненты
- **Frontend:** Step-by-step UI, карточки результатов, панель настроек
- **Backend:** API Whisper, расчёт метрик, справочник моделей

---

## 2. Изменения метрик по шагам

### 2.1 Метаданные (parse)
| Метрика | Было | Стало | Комментарий |
|---------|------|-------|-------------|
| Длительность | ✓ | ✓ | Оставить |
| Время обработки | ✓ | ✗ | Убрать (быстрая операция) |

**Итого показывать:** только длительность аудио/видео

---

### 2.2 Транскрипция (transcribe)
| Метрика | Было | Стало | Источник |
|---------|------|-------|----------|
| Язык | ✓ | ✓ | Whisper API |
| Язык (%) | ✓ | ✗ | Убрать |
| Символы | ✗ | ✓ | **Добавить** |
| Слова | ✓ | ✓ | Оставить |
| Сегменты | ✓ | ✗ | Убрать |
| Темп речи | ✓ | ✗ | Убрать |
| **Confidence** | ✗ | ✓ | **Добавить** (см. раздел 4.1) |
| Время обработки | ✓ | ✓ | Оставить |

**Итого показывать:** язык, символы, слова, confidence, время

---

### 2.3 Очистка текста (clean)
| Метрика | Было | Стало | Комментарий |
|---------|------|-------|-------------|
| Символы | ✓ | ✓ | Оставить |
| Слова | ✗ | ✓ | **Добавить** |
| % изменения | ✗ | ✓ | **Добавить** (по символам vs транскрипт) |
| Статистика исправлений | ✓ | ✗ | Убрать (требует regex, но используем LLM) |
| Токены (вх/вых) | ✓ | ✓ | Оставить |
| Стоимость | ✗ | ✓ | **Добавить** (см. раздел 4.2) |
| Время обработки | ✓ | ✓ | Оставить |
| **Diff View** | ✗ | ✓ | **Добавить** (сравнение с транскриптом) |

**Итого показывать:** символы, слова, % изменения, токены, стоимость, время + кнопка Diff

---

### 2.4 Лонгрид (longread)
| Метрика | Было | Стало | Комментарий |
|---------|------|-------|-------------|
| Символы | ✓ | ✓ | Оставить |
| Слова | ✗ | ✓ | **Добавить** |
| % изменения | ✗ | ✓ | **Добавить** (по символам vs очистка) |
| Кол-во секций | ✓ | ✗ | Убрать (шаблонное, структура известна) |
| Структура | ✓ | ✗ | Убрать (plain text для сравнения) |
| Токены (вх/вых) | ✓ | ✓ | Оставить |
| Стоимость | ✗ | ✓ | **Добавить** |
| Время обработки | ✓ | ✓ | Оставить |
| **Diff View** | ✗ | ✓ | **Добавить** (сравнение с очисткой) |

**Итого показывать:** символы, слова, % изменения, токены, стоимость, время + кнопка Diff

---

### 2.5 Конспект (summarize)
| Метрика | Было | Стало | Комментарий |
|---------|------|-------|-------------|
| Символы | ✗ | ✓ | **Добавить** |
| Слова | ✗ | ✓ | **Добавить** |
| Кол-во концепций | ✓ | ✗ | Убрать (шаблонное) |
| Кол-во цитат | ✓ | ✗ | Убрать (шаблонное) |
| Токены (вх/вых) | ✓ | ✓ | Оставить |
| Стоимость | ✗ | ✓ | **Добавить** |
| Время обработки | ✓ | ✓ | Оставить |

**Итого показывать:** символы, слова, токены, стоимость, время

---

### 2.6 Чанки (chunk)
| Метрика | Было | Стало | Комментарий |
|---------|------|-------|-------------|
| Всего чанков | ✓ | ✓ | Оставить |
| Всего токенов | ✓ | ✓ | Оставить |
| Overlap | ✓ | ✗ | Убрать (разбиение по H2, без overlap) |

**Итого показывать:** количество чанков, общее количество токенов

---

### 2.7 Итоги обработки (save/completion)
| Метрика | Было | Стало | Комментарий |
|---------|------|-------|-------------|
| Список файлов | ✓ | ✓ | Оставить |
| Общее время | ✓ | ✓ | Оставить |
| Токены (вх/вых) | ✓ | ✓ | Оставить |
| **Общая стоимость** | ✗ | ✓ | **Добавить** |

**Важно:** Блок итогов без скролла — высота адаптируется под содержимое.

---

## 3. Изменения UI

### 3.1 Панель настроек шага

#### Было:
- 4 промпта: system, instructions, template, user
- Не у всех шагов были настройки

#### Стало:
- **2 промпта:** system, user
- Настройки для шагов: transcribe, clean, longread, summarize, **chunk**

```
┌─────────────────────────────────────┐
│ Модель          [cloud] / [local]   │
│ ┌───────────────────────────────┐   │
│ │ Claude Sonnet 4.5           ▼ │   │
│ └───────────────────────────────┘   │
│                                     │
│ Промпты                             │
│ ┌──────────┐  ┌──────────┐          │
│ │ system ▼ │  │ user   ▼ │          │
│ └──────────┘  └──────────┘          │
│                                     │
│ [🔄 Перезапустить]                  │
└─────────────────────────────────────┘
```

### 3.2 Diff View

**Реализация:** Toggle-режим (замена контента), НЕ вложенное модальное окно.

```
┌─────────────────────────────────────────────────────────────┐
│ [← Назад]  Сравнение текстов    ☑ Синхронный скролл  -60 симв. (-5%) │
├────────────────────────────┬────────────────────────────────┤
│ Транскрипт                 │ Очистка                        │
│ 1,247 симв. · 214 слов     │ 1,187 симв. · 198 слов         │
├────────────────────────────┼────────────────────────────────┤
│                            │                                │
│ [Текст слева]              │ [Текст справа]                 │
│                            │                                │
│ (синхронный скролл)        │ (синхронный скролл)            │
│                            │                                │
└────────────────────────────┴────────────────────────────────┘
```

**Где доступен:**
- Очистка → сравнение с транскриптом
- Лонгрид → сравнение с очисткой

### 3.3 Формат времени

```javascript
// < 1 сек
"235мс"

// < 60 сек
"23с"

// >= 60 сек
"1м 23с"
"2м 45с"
```

### 3.4 Высота контента

Все блоки результатов (транскрипт, очистка, лонгрид и т.д.) занимают **всю доступную высоту** формы:

```jsx
<div className="flex flex-col h-full">
  <header>...</header>
  <div className="flex-1 overflow-y-auto min-h-0">
    {/* контент */}
  </div>
  <footer>...</footer>
</div>
```

---

## 4. Требования к бэкенду

### 4.1 Confidence от Whisper

**Задача:** Получать и отображать уверенность распознавания.

**Источник данных:**  
Whisper API возвращает `avg_logprob` для каждого сегмента.

**Формула преобразования:**
```python
# Для каждого сегмента
segment_confidence = math.exp(segment['avg_logprob'])

# Среднее по всем сегментам
total_confidence = sum(confidences) / len(confidences)

# В процентах
confidence_percent = round(total_confidence * 100)
```

**Пример ответа API:**
```json
{
  "text": "...",
  "segments": [
    {
      "id": 0,
      "start": 0.0,
      "end": 5.2,
      "text": "Спасибо, Даша...",
      "avg_logprob": -0.15,
      "no_speech_prob": 0.01
    }
  ]
}
```

**Интерпретация:**

| Confidence | Качество |
|------------|----------|
| > 90% | Отличное |
| 80-90% | Хорошее |
| 70-80% | Среднее |
| < 70% | Низкое (шум, плохая запись) |

**Применение:** Оценка качества аудиозаписи, сравнение моделей Whisper.

---

### 4.2 Справочник цен моделей

**Задача:** Хранить и использовать цены моделей для расчёта стоимости.

**Структура справочника:**
```python
MODEL_PRICING = {
    # Claude models (per 1M tokens)
    "claude-sonnet-4-5": {
        "input": 3.00,
        "output": 15.00,
        "name": "Claude Sonnet 4.5"
    },
    "claude-haiku-4-5": {
        "input": 0.80,
        "output": 4.00,
        "name": "Claude Haiku 4.5"
    },
    "claude-opus-4-5": {
        "input": 15.00,
        "output": 75.00,
        "name": "Claude Opus 4.5"
    },
    
    # Local models (free)
    "large-v3-turbo": {
        "input": 0,
        "output": 0,
        "name": "Whisper large-v3-turbo"
    },
    "large-v3": {
        "input": 0,
        "output": 0,
        "name": "Whisper large-v3"
    },
    "gemma2:9b": {
        "input": 0,
        "output": 0,
        "name": "Gemma2 9B (Ollama)"
    },
}
```

**Формула расчёта:**
```python
def calculate_cost(model: str, input_tokens: int, output_tokens: int) -> float:
    pricing = MODEL_PRICING.get(model)
    if not pricing or (pricing["input"] == 0 and pricing["output"] == 0):
        return 0
    
    cost = (input_tokens / 1_000_000 * pricing["input"]) + \
           (output_tokens / 1_000_000 * pricing["output"])
    return cost
```

**Формат отображения:**
```python
def format_cost(cost: float) -> str:
    if cost == 0:
        return "бесплатно"
    if cost < 0.01:
        return f"~${cost:.4f}"
    return f"~${cost:.2f}"
```

---

### 4.3 API Response — расширенные метрики

**Текущий формат (примерный):**
```json
{
  "step": "clean",
  "result": {
    "text": "...",
    "model": "claude-sonnet-4-5",
    "processing_time_sec": 6
  }
}
```

**Требуемый формат:**
```json
{
  "step": "clean",
  "result": {
    "text": "...",
    "model": "claude-sonnet-4-5",
    "chars": 1187,
    "words": 198,
    "original_chars": 1247,
    "change_percent": -4.8,
    "tokens_used": {
      "input": 1850,
      "output": 1720
    },
    "cost": 0.0314,
    "processing_time_sec": 6
  }
}
```

---

### 4.4 Подсчёт слов

**Требование:** Все текстовые результаты должны включать количество слов.

**Реализация (Python):**
```python
def count_words(text: str) -> int:
    return len([w for w in text.split() if w.strip()])
```

**Реализация (JavaScript):**
```javascript
function countWords(text) {
  return text.trim().split(/\s+/).filter(w => w.length > 0).length;
}
```

---

## 5. Чеклист реализации (с приоритетами)

### Frontend — Высокий приоритет 🔴

- [x] **Транскрипт:** убрать "сегменты", добавить язык, символы, слова, confidence, время (v0.45)
- [x] **Очистка:** добавить слова, токены, стоимость, время, кнопку Diff (v0.45, v0.46)
- [x] **Лонгрид:** убрать "секции", добавить символы, %, токены, стоимость, время, кнопку Diff (v0.45, v0.46)
- [x] **Конспект:** убрать "концепции/цитаты", добавить символы, слова, токены, стоимость, время (v0.45)
- [x] **Чанки:** заменить "слов/чанк" на "общие токены" (v0.45)
- [x] **Итоги:** добавить размеры файлов, общее время, токены, стоимость (v0.46)

### Frontend — Средний приоритет 🟡

- [x] Реализовать Diff View (toggle-режим) для очистки и лонгрида (v0.46)
- [x] Добавить footer с токенами и стоимостью для LLM-шагов (v0.45)
- [x] Обновить формат времени (минуты и секунды для > 60с) (v0.44)
- [x] Растянуть контент на всю высоту формы (`flex-1 h-full min-h-0`) (v0.46)

### Frontend — Низкий приоритет 🟢

- [ ] Улучшить визуальное оформление метаданных (сетка 2 колонки)
- [x] Добавить badge cloud/local для модели в настройках (v0.35+)
- [x] Убрать скролл в блоке итогов (адаптивная высота) (v0.46)

### Backend — Высокий приоритет 🔴

- [x] Добавить подсчёт символов и слов во все текстовые результаты (v0.42)
- [x] Добавить токены (input/output) в response каждого LLM-шага (v0.42)
- [x] Добавить % изменения (очистка vs транскрипт, лонгрид vs очистка) (v0.42)
- [x] Добавить время обработки для каждого шага (v0.42)

### Backend — Средний приоритет 🟡

- [x] Реализовать расчёт confidence из Whisper API (avg_logprob) (v0.42)
- [x] Создать/обновить справочник цен моделей (v0.42)
- [x] Добавить расчёт стоимости в response (v0.42)
- [x] Обновить API response согласно разделу 4.3 (v0.42)

### Backend — Низкий приоритет 🟢

- [x] Добавить размеры файлов в итоги сохранения (v0.46)
- [ ] Оптимизировать подсчёт токенов (кэширование)

## 6. Визуальное сравнение: Было → Стало

### 6.1 Header результата (пример: Очистка)

**БЫЛО:**
```
┌────────────────────────────────────────────────────────────────┐
│ Очищенная транскрипция                      4 187 симв.  -5%  │
│                                                                │
│ Модель: claude-sonnet-4-5                                      │
└────────────────────────────────────────────────────────────────┘
```

**СТАЛО:**
```
┌────────────────────────────────────────────────────────────────┐
│ Очищенная транскрипция    [claude-sonnet-4-5]                  │
│                                                                │
│ 4 187 симв. | 698 слов | -5% | 6с                              │
├────────────────────────────────────────────────────────────────┤
│ [📊 Сравнить с транскриптом]                                   │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│ [Текст...]                                                     │
│                                                                │
├────────────────────────────────────────────────────────────────┤
│ Токены: 1 850 вх. / 1 720 вых.                       ~$0.03    │
└────────────────────────────────────────────────────────────────┘
```

### 6.2 Header результата (пример: Транскрипт)

**БЫЛО:**
```
┌────────────────────────────────────────────────────────────────┐
│ Сырая транскрипция                       ⏱ 5:01  84 сегментов  │
│                                                                │
│ Модель: large-v3-turbo                                         │
└────────────────────────────────────────────────────────────────┘
```

**СТАЛО:**
```
┌────────────────────────────────────────────────────────────────┐
│ Сырая транскрипция        [large-v3-turbo]                     │
│                                                                │
│ RU | 4 412 симв. | 756 слов | 📈 94% | 23с                     │
└────────────────────────────────────────────────────────────────┘
```

### 6.3 Header результата (пример: Конспект)

**БЫЛО:**
```
┌────────────────────────────────────────────────────────────────┐
│ Конспект                              4 концепции    4 цитат   │
│                                                                │
│ Модель: claude-sonnet-4-5                                      │
└────────────────────────────────────────────────────────────────┘
```

**СТАЛО:**
```
┌────────────────────────────────────────────────────────────────┐
│ Конспект                  [claude-sonnet-4-5]                  │
│                                                                │
│ 723 симв. | 98 слов | 5с                                       │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│ [Текст...]                                                     │
│                                                                │
├────────────────────────────────────────────────────────────────┤
│ Токены: 1 720 вх. / 520 вых.                         ~$0.01    │
└────────────────────────────────────────────────────────────────┘
```

### 6.4 Блок итогов

**БЫЛО:**
```
┌─────────────────────────────────┐
│ ✓ Успешно сохранено             │
│                                 │
│ • pipeline_results.json         │
│ • transcript_chunks.json        │
│ • longread.md                   │
│ • summary.md                    │
│ • transcript_raw.txt            │
│ • transcript_cleaned.txt        │
│ • audio.mp3                     │
│ • 2026.01 Форум Табтим...mp3    │
│                                 │
│ [Закрыть]                       │
└─────────────────────────────────┘
```

**СТАЛО:**
```
┌─────────────────────────────────┐
│ ✓ Успешно сохранено             │
│   7 файлов                      │
│                                 │
│ pipeline_results.json    12.4KB │
│ transcript_chunks.json    8.2KB │
│ longread.md               4.1KB │
│ summary.md                2.8KB │
│ transcript_raw.txt        4.4KB │
│ transcript_cleaned.txt    4.2KB │
│ audio.mp3                12.4MB │
│                                 │
│ ┌─────────────────────────────┐ │
│ │ Общее время:          43с   │ │
│ │ Токены:    5 290 / 3 130    │ │
│ │ Стоимость:        ~$0.06    │ │
│ └─────────────────────────────┘ │
│                                 │
│ [Закрыть]                       │
└─────────────────────────────────┘
```

### 6.5 Чанки

**БЫЛО:**
```
┌────────────────────────────────────────────────────────────────┐
│ Чанки                                  1 чанков  ~513 слов/чанк│
│                                                                │
│ Модель: deterministic                                          │
└────────────────────────────────────────────────────────────────┘
```

**СТАЛО:**
```
┌────────────────────────────────────────────────────────────────┐
│ Чанки                                  1 чанков    680 токенов │
└────────────────────────────────────────────────────────────────┘
```

---

## 7. Референсы

- **UI-компонент:** `SettingsModal-reference.jsx`
- **Справочник моделей:** см. раздел 4.2
- **Формулы расчёта:** см. разделы 4.1, 4.2

---

## 8. Реализовано

### v0.42 — Backend метрики

**Дата:** 2026-01-22

- `TokensUsed` модель с computed `total`
- `ChatUsage` dataclass в AI клиентах
- Confidence из avg_logprob в transcriber
- Token tracking и cost calculation во всех LLM сервисах
- Pricing в `config/models.yaml`
- `pricing_utils.py` — расчёт стоимости

### v0.43 — Унификация AI клиентов

**Дата:** 2026-01-22

- Единый интерфейс: `chat()` и `generate()` возвращают `tuple[str, ChatUsage]`
- `ChatUsage` перенесён в `base.py`
- Убраны все `isinstance()` проверки в сервисах

### v0.44 — Frontend типы и утилиты

**Дата:** 2026-01-22

- `TokensUsed` interface в TypeScript
- Расширены типы: `RawTranscript`, `CleanedTranscript`, `Longread`, `Summary`, `Story`, `TranscriptChunks`
- `formatUtils.ts`: `formatTime()`, `formatCost()`, `formatNumber()`, `formatTokens()`

### v0.45 — Компоненты результатов

**Дата:** 2026-01-22

- `ResultFooter` компонент для отображения токенов, стоимости, модели
- Обновлены все view-компоненты с новыми метриками
- Убраны избыточные метрики (сегменты, секции, концепции/цитаты)

### v0.46 — Diff View и CompletionCard

**Дата:** 2026-01-22

- `InlineDiffView` компонент с синхронным скроллом
- `CompletionCard` компонент с итоговыми метриками
- Интеграция diff view в CleanedTranscriptView и LongreadView
- Функция `calculateTotals()` для суммирования метрик

---

## 9. История изменений

| Дата | Версия | Изменения |
|------|--------|-----------|
| 2026-01-22 | 1.0 | Первоначальная версия требований |
| 2026-01-22 | 1.1 | Добавлен анализ текущей реализации по скриншотам |
| 2026-01-22 | 2.0 | ✅ Реализация завершена (v0.42—v0.46). Чеклист обновлён |
