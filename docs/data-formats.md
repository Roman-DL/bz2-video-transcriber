# Форматы данных

> Описание входных и выходных форматов файлов системы bz2-video-transcriber для интеграции с БЗ 2.0.

## Входящие файлы

### Паттерн имени файла

```
{дата} {тип}.{поток} {тема} ({спикер}).mp4
```

**Пример:**
```
2025.04.07 ПШ.SV Подготовка и проведение Группы поддержки (Светлана Дмитрук).mp4
```

### Компоненты имени

| Компонент | Формат | Пример | Обязательный |
|-----------|--------|--------|--------------|
| Дата | `YYYY.MM.DD` | `2025.04.07` | ✓ |
| Тип | Код мероприятия | `ПШ` | ✓ |
| Поток | Код аудитории | `SV`, `НП` | ✓ |
| Тема | Свободный текст | `Подготовка и проведение Группы поддержки` | ✓ |
| Спикер | В скобках | `Светлана Дмитрук` | ✓ |

### Regex для парсинга

```python
FILENAME_PATTERN = r'^(\d{4}\.\d{2}\.\d{2})\s+(\w+)\.(\w+)\s+(.+?)\s+\(([^)]+)\)(?:\.\w+)?$'

# Группы захвата:
# 1: date       → 2025.04.07
# 2: event_type → ПШ
# 3: stream     → SV
# 4: title      → Подготовка и проведение Группы поддержки
# 5: speaker    → Светлана Дмитрук
```

### Типы мероприятий (config/events.yaml)

```yaml
event_types:
  ПШ:
    name: "Понедельничная Школа"
    streams:
      SV: "Супервайзеры"
      НП: "Независимые партнёры"
  
  # Будущие типы
  ВБ:
    name: "Вебинар"
    streams:
      ALL: "Все участники"
```

---

## Структура архива

### Иерархия папок

```
/archive/
└── {год}/
    └── {месяц}/
        └── {тип}.{поток}/
            └── {тема} ({спикер})/
                ├── {оригинальное_название}.mp4
                ├── audio.mp3
                ├── transcript_chunks.json
                ├── longread.md
                ├── summary.md
                ├── transcript_raw.txt
                ├── transcript_cleaned.txt
                ├── pipeline_results.json
                └── .cache/                   # Версионированный кэш (v0.18+)
```

### Пример

```
/archive/
└── 2025/
    └── 04/
        ├── ПШ.SV/
        │   ├── Подготовка и проведение Группы поддержки (Светлана Дмитрук)/
        │   │   ├── 2025.04.07 ПШ.SV Подготовка и проведение Группы поддержки (Светлана Дмитрук).mp4
        │   │   ├── audio.mp3
        │   │   ├── transcript_chunks.json
        │   │   ├── longread.md
        │   │   ├── summary.md
        │   │   ├── transcript_raw.txt
        │   │   ├── transcript_cleaned.txt
        │   │   └── pipeline_results.json
        │   │
        │   └── Работа с возражениями (Иван Петров)/
        │       └── ...
        │
        └── ПШ.НП/
            └── Первые шаги в бизнесе (Анна Сидорова)/
                └── ...
```

---

## JSON API сериализация (v0.59+)

С версии v0.59 все JSON ответы API и файл `pipeline_results.json` используют **camelCase** для ключей.

### Преобразование форматов

| Python (snake_case) | JSON/TypeScript (camelCase) |
|---------------------|----------------------------|
| `raw_transcript` | `rawTranscript` |
| `cleaned_transcript` | `cleanedTranscript` |
| `slides_extraction` | `slidesExtraction` |
| `tokens_used` | `tokensUsed` |
| `processing_time_sec` | `processingTimeSec` |
| `original_length` | `originalLength` |
| `cleaned_length` | `cleanedLength` |
| `change_percent` | `changePercent` |
| `model_name` | `modelName` |
| `video_id` | `videoId` |
| `word_count` | `wordCount` |
| `chars_count` | `charsCount` |
| `total_chunks` | `totalChunks` |
| `avg_chunk_size` | `avgChunkSize` |

### Реализация (backend)

Все Pydantic модели наследуют от `CamelCaseModel`:

```python
from pydantic import BaseModel, ConfigDict
from pydantic.alias_generators import to_camel

class CamelCaseModel(BaseModel):
    """Python: snake_case, JSON: camelCase."""
    model_config = ConfigDict(
        alias_generator=to_camel,
        populate_by_name=True,  # принимает оба формата на входе
    )

# Пример модели
class CleanedTranscript(CamelCaseModel):
    text: str
    original_length: int  # → JSON: originalLength
    cleaned_length: int   # → JSON: cleanedLength
    model_name: str       # → JSON: modelName
```

### Обратная совместимость

- `populate_by_name=True` позволяет **принимать** оба формата (snake_case и camelCase)
- **Ответы** API всегда в camelCase
- Старые `pipeline_results.json` в snake_case требуют обработки или пересохранения

Подробнее: [ADR-013: CamelCase сериализация](adr/013-api-camelcase-serialization.md)

---

## Выходные файлы

### 1. transcript_chunks.json

**Назначение:** Chunks для RAG-индексации в БЗ 2.0

**Использование в БЗ 2.0:**
- BZ2_Indexer читает этот файл
- Каждый chunk индексируется отдельно с embeddings
- RAG Search находит релевантные chunks по вопросу пользователя

```json
{
  "video_id": "2025-04-07_psh-sv_gruppa-podderzhki",
  
  "metadata": {
    "title": "Подготовка и проведение Группы поддержки",
    "speaker": "Светлана Дмитрук",
    "date": "2025-04-07",
    "event_type": "ПШ",
    "stream": "SV",
    "stream_name": "Понедельничная Школа — Супервайзеры",
    "duration_seconds": 5025,
    "duration_formatted": "01:23:45",
    "language": "ru",
    "whisper_model": "large-v3",
    "processed_at": "2025-04-08T10:30:00Z"
  },
  
  "statistics": {
    "total_chunks": 24,
    "avg_chunk_words": 285,
    "total_words": 6840,
    "cleaning_reduction_percent": 18.5
  },
  
  "chunks": [
    {
      "id": "2025-04-07_psh-sv_gruppa-podderzhki_001",
      "index": 1,
      "topic": "Введение и цели Группы поддержки",
      "text": "Сегодня мы поговорим о том, как правильно готовить и проводить Группу поддержки. Это один из ключевых инструментов работы с командой. Группа поддержки помогает консультантам обмениваться опытом, получать мотивацию и учиться друг у друга...",
      "word_count": 312
    },
    {
      "id": "2025-04-07_psh-sv_gruppa-podderzhki_002",
      "index": 2,
      "topic": "Подготовка помещения и материалов",
      "text": "Перед проведением Группы поддержки важно подготовить помещение. Расставьте стулья полукругом, чтобы все участники видели друг друга. Подготовьте флипчарт или доску для записей. Не забудьте про образцы продуктов Herbalife — Формула 1, Формула 2, протеиновые батончики...",
      "word_count": 276
    }
  ]
}
```

### Поля chunk

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | string | Уникальный ID: `{video_id}_{index:03d}` |
| `index` | int | Порядковый номер (1, 2, 3...) |
| `topic` | string | Краткая тема блока (3-7 слов) |
| `text` | string | Полный текст блока (100-400 слов) |
| `word_count` | int | Количество слов в блоке |

---

### 2. longread.md

**Назначение:** Развёрнутый структурированный текст (5-10 страниц) для детального изучения

**Использование:**
- Полное изложение материала без устной речи
- Структурированные секции с заголовками
- Включает введение и заключение

```markdown
---
title: "Подготовка и проведение Группы поддержки"
speaker: "Светлана Дмитрук"
date: "2025-04-07"
duration: "01:23:45"
section: "Обучение"
subsection: "Работа с командой"
tags:
  - группа поддержки
  - командная работа
  - обучение консультантов
access_level: 1
word_count: 3500
---

# Подготовка и проведение Группы поддержки

> Спикер: Светлана Дмитрук | Дата: 7 апреля 2025 | Длительность: 01:23:45

## Введение

Группа поддержки — один из ключевых инструментов работы с командой консультантов Herbalife. В этом материале мы рассмотрим полный цикл подготовки и проведения эффективной встречи...

## 1. Подготовка помещения

Первый шаг к успешной Группе поддержки — правильная подготовка пространства. Расставьте стулья полукругом, чтобы все участники видели друг друга...

## 2. Структура встречи

Оптимальная структура встречи включает несколько ключевых блоков...

## 3. Работа с участниками

Важно вовлекать каждого участника в обсуждение...

## Заключение

Группа поддержки — это инвестиция в вашу команду. Регулярные встречи создают культуру взаимопомощи и способствуют росту каждого участника...
```

### Поля frontmatter longread.md

| Поле | Тип | Описание | Пример |
|------|-----|----------|--------|
| `title` | string | Название видео | `Подготовка и проведение...` |
| `speaker` | string | Имя спикера | `Светлана Дмитрук` |
| `date` | string | Дата записи (ISO) | `2025-04-07` |
| `duration` | string | Длительность | `01:23:45` |
| `section` | string | Раздел БЗ 2.0 | `Обучение` |
| `subsection` | string | Подраздел | `Работа с командой` |
| `tags` | array | Теги для поиска | `[группа поддержки, ...]` |
| `access_level` | int | Уровень доступа (1-4) | `1` |
| `word_count` | int | Количество слов | `3500` |

---

### 3. summary.md

**Назначение:** Конспект с callouts для File Search в БЗ 2.0

**Использование в БЗ 2.0:**
- File Search Agent находит видео по описанию
- Frontmatter используется для фильтрации (section, tags, access_level)
- Obsidian callouts структурируют информацию для быстрого ознакомления

```markdown
---
title: "Подготовка и проведение Группы поддержки"
speaker: "Светлана Дмитрук"
date: "2025-04-07"
duration: "01:23:45"
section: "Обучение"
subsection: "Работа с командой"
tags:
  - группа поддержки
  - командная работа
  - мотивация
access_level: 1
type: summary
---

# Подготовка и проведение Группы поддержки

> Спикер: Светлана Дмитрук | Дата: 7 апреля 2025 | Длительность: 01:23:45

> [!abstract] Суть
> Светлана Дмитрук рассказывает о ключевых принципах организации Группы поддержки — регулярных встреч команды консультантов. Видео охватывает полный цикл от подготовки до follow-up.

> [!info] Ключевые концепции
> - **Группа поддержки** — еженедельная встреча команды для обмена опытом
> - **Формат полукруга** — расстановка для максимального вовлечения
> - **Ротация ролей** — каждый участник пробует себя ведущим

> [!tip] Практические инструменты
> - Чек-лист подготовки помещения
> - Шаблон повестки встречи на 60 минут
> - Техника "3 вопроса" для вовлечения

> [!quote] Цитаты
> - "Группа поддержки — это не лекция, а диалог между участниками"
> - "Регулярность важнее длительности"

> [!success] Главный инсайт
> Группа поддержки — это инвестиция в команду. Регулярные встречи создают культуру взаимопомощи.

> [!todo] К действию
> - [ ] Определить день и время для еженедельной ГП
> - [ ] Составить список из 10 тем на первые 2 месяца
> - [ ] Подготовить помещение по чек-листу
```

### Поля frontmatter summary.md

| Поле | Тип | Описание | Пример |
|------|-----|----------|--------|
| `title` | string | Название видео | `Подготовка и проведение...` |
| `speaker` | string | Имя спикера | `Светлана Дмитрук` |
| `date` | string | Дата записи (ISO) | `2025-04-07` |
| `duration` | string | Длительность | `01:23:45` |
| `section` | string | Раздел БЗ 2.0 | `Обучение` |
| `subsection` | string | Подраздел | `Работа с командой` |
| `access_level` | int | Уровень доступа (1-4) | `1` |
| `tags` | array | Теги для поиска | `[группа поддержки, ...]` |
| `type` | string | Тип документа | `summary` |

### Секции конспекта (Obsidian callouts)

| Callout | Содержание |
|---------|------------|
| `[!abstract] Суть` | Краткое описание видео (2-3 предложения) |
| `[!info] Ключевые концепции` | Основные термины и понятия |
| `[!tip] Практические инструменты` | Техники и методики |
| `[!quote] Цитаты` | Запоминающиеся высказывания спикера |
| `[!success] Главный инсайт` | Ключевая мысль видео |
| `[!todo] К действию` | Рекомендуемые шаги |

---

### 4. story.md (v0.23+, Leadership only)

**Назначение:** 8-блочная лидерская история для content_type=LEADERSHIP

**Использование:**
- Структурированный рассказ о пути лидера/семьи в бизнесе
- Вместо longread.md + summary.md для лидерских историй
- Фиксированная структура из 8 блоков

```markdown
---
title: "История Антоновых"
names: "Дмитрий и Юлия Антоновы"
current_status: "GET Team"
event_name: "Форум TABTeam (Москва)"
date: "2025-01-15"
time_in_business: "12 лет"
time_to_status: "8 лет"
speed: "средне"
business_format: "гибрид"
is_family: true
had_stagnation: true
stagnation_years: 3
had_restart: false
tags:
  - GET Team
  - семейный бизнес
  - стагнация
access_level: leader
---

# История Антоновых: от консультантов до GET Team

> Дмитрий и Юлия Антоновы | GET Team | 12 лет в бизнесе

## Главный инсайт

Системность и партнёрство с супругой — ключ к преодолению стагнации.

---

## 1. Кто они

Дмитрий — инженер по образованию, Юлия — педагог. Познакомились с Herbalife в 2013 году...

## 2. Путь в бизнес

Начали как клиенты программы снижения веса. Дмитрий похудел на 15 кг за 3 месяца...

## 3. Рост и вызовы

Первые три года — быстрый рост до Супервайзера. Затем 3 года стагнации...

## 4. Ключ к статусу

Переломный момент — решение работать как семейная команда. Чёткое разделение ролей...

## 5. Как устроен бизнес

Гибридный формат: офлайн-клуб в городе + онлайн-консультации для регионов...

## 6. Принципы и советы

1. Работайте с супругом/супругой как с бизнес-партнёром
2. Не бойтесь стагнации — используйте её для переосмысления
3. Стройте систему, а не зависьте от себя

## 7. Итоги

12 лет в бизнесе. Статус GET Team. Команда из 150+ активных партнёров...

## 8. Заметки аналитика

Характерный паттерн "семейная команда" + преодоление стагнации через системность...

---

**Метаданные:**
- Наставник: Иван Петров
- Ключевой паттерн: семейная команда
- Связанные истории: Семья Ивановых, Семья Сидоровых
```

### Поля frontmatter story.md

| Поле | Тип | Описание | Пример |
|------|-----|----------|--------|
| `names` | string | Имена лидеров | `Дмитрий и Юлия Антоновы` |
| `current_status` | string | Текущий статус | `GET Team` |
| `event_name` | string | Название мероприятия | `Форум TABTeam (Москва)` |
| `time_in_business` | string | Время в бизнесе | `12 лет` |
| `time_to_status` | string | Время до текущего статуса | `8 лет` |
| `speed` | string | Скорость роста | `быстро/средне/долго/очень долго` |
| `business_format` | string | Формат бизнеса | `клуб/онлайн/гибрид` |
| `is_family` | bool | Семейный бизнес | `true/false` |
| `had_stagnation` | bool | Была стагнация | `true/false` |
| `stagnation_years` | int | Лет стагнации | `3` |
| `had_restart` | bool | Был рестарт | `true/false` |
| `access_level` | string | Уровень доступа | `consultant/leader/personal` |

### 8 блоков Story

| № | Название | Содержание |
|---|----------|------------|
| 1 | Кто они | Предыстория: образование, семья, чем занимались до |
| 2 | Путь в бизнес | Как пришли в Herbalife, первый опыт |
| 3 | Рост и вызовы | Этапы развития, трудности, преодоление |
| 4 | Ключ к статусу | Переломный момент, что изменило траекторию |
| 5 | Как устроен бизнес | Формат работы, география, команда |
| 6 | Принципы и советы | Ключевые рекомендации от лидеров |
| 7 | Итоги | Текущие результаты, достижения |
| 8 | Заметки аналитика | Аналитические наблюдения, паттерны |

### Секции БЗ 2.0

| Section | Описание |
|---------|----------|
| `Обучение` | Тренинги, развитие навыков |
| `Продукты` | Информация о продуктах Herbalife |
| `Бизнес` | Построение бизнеса, продажи |
| `Мотивация` | Истории успеха, вдохновение |

### Уровни доступа

| Level | Роль | Описание |
|-------|------|----------|
| 1 | Консультант | Базовый доступ |
| 2 | Спонсор | Расширенный доступ |
| 3 | TAB Team | Полный доступ к данным |
| 4 | Администратор | Все материалы + управление |

---

### 4. audio.mp3

**Назначение:** Извлечённая аудиодорожка из видео

**Параметры:**
- Формат: MP3
- Битрейт: 128 kbps
- Sample rate: 44100 Hz

**Использование:**
- Резервная копия аудио для переобработки
- Быстрое прослушивание без загрузки видео
- Размер ~10% от видеофайла

**Почему сохраняем:** При транскрипции длинных видео извлечение аудио повышает надёжность обработки Whisper. Сохраняем файл чтобы не извлекать повторно при переобработке.

---

### 5. transcript_raw.txt

**Назначение:** Backup оригинального транскрипта с тайм-кодами

**Использование:** Для ручной проверки и возможной переобработки

```text
[00:00:00] Всем привет! Сегодня мы поговорим о том, как правильно готовить и проводить Группу поддержки.
[00:00:08] Это один из ключевых инструментов работы с командой.
[00:00:15] Группа поддержки помогает консультантам обмениваться опытом.
[00:00:22] Получать мотивацию и учиться друг у друга.
[00:00:30] Давайте начнём с подготовки.
[00:00:35] Перед проведением Группы поддержки важно подготовить помещение.
[00:00:42] Расставьте стулья полукругом, чтобы все участники видели друг друга.
...
```

**Формат строки:**
```
[HH:MM:SS] Текст сегмента от Whisper
```

---

### 6. transcript_cleaned.txt

**Назначение:** Очищенный транскрипт после обработки LLM

**Использование:**
- Ручное чтение и редактирование
- Импорт в другие системы
- Более чистый текст без артефактов Whisper

**Формат:** Простой текст без таймкодов, с исправленной терминологией и пунктуацией.

```text
Всем привет! Сегодня мы поговорим о том, как правильно готовить и проводить Группу поддержки. Это один из ключевых инструментов работы с командой. Группа поддержки помогает консультантам обмениваться опытом, получать мотивацию и учиться друг у друга.

Давайте начнём с подготовки. Перед проведением Группы поддержки важно подготовить помещение. Расставьте стулья полукругом, чтобы все участники видели друг друга.
...
```

**Отличия от transcript_raw.txt:**
- Без таймкодов
- Исправлена терминология (по глоссарию)
- Улучшена пунктуация и форматирование
- Удалены артефакты распознавания

---

### 7. pipeline_results.json

**Назначение:** Полные результаты обработки для просмотра в веб-интерфейсе

**Использование:**
- Просмотр результатов обработки при клике на файл в архиве
- Позволяет анализировать качество обработки ранее обработанных файлов
- Содержит все промежуточные данные pipeline

**Версионирование и совместимость:**
- Файл содержит поле `version` для информации
- Текущая версия: `1.0.0`
- **UI показывает любую версию** — см. [Архитектурное решение о совместимости](#архитектурное-решение-о-совместимости)

```json
{
  "version": "1.0.0",
  "createdAt": "2025-01-12T10:30:00Z",

  "metadata": {
    "date": "2025-04-07",
    "eventType": "ПШ",
    "stream": "SV",
    "title": "Подготовка и проведение Группы поддержки",
    "speaker": "Светлана Дмитрук",
    "originalFilename": "2025.04.07 ПШ.SV Подготовка и проведение Группы поддержки (Светлана Дмитрук).mp4",
    "videoId": "2025-04-07_psh-sv_gruppa-podderzhki",
    "sourcePath": "/data/inbox/...",
    "archivePath": "/data/archive/2025/04/...",
    "streamFull": "Понедельничная Школа — Супервайзеры",
    "durationSeconds": 5025
  },

  "rawTranscript": {
    "segments": [
      {"start": 0.0, "end": 5.2, "text": "...", "startTime": "00:00:00", "endTime": "00:00:05"}
    ],
    "language": "ru",
    "durationSeconds": 5025.5,
    "whisperModel": "large-v3",
    "fullText": "Полный текст без таймкодов...",
    "textWithTimestamps": "[00:00:00] Текст...\n[00:00:05] Текст..."
  },

  "displayText": "[00:00:00] Текст...",

  "cleanedTranscript": {
    "text": "Очищенный текст транскрипции...",
    "originalLength": 15000,
    "cleanedLength": 12500,
    "modelName": "claude-sonnet-4-5"
  },

  "chunks": {
    "chunks": [
      {"id": "chunk_001", "index": 1, "topic": "Введение", "text": "...", "wordCount": 285}
    ],
    "totalChunks": 24,
    "avgChunkSize": 285,
    "modelName": "deterministic"
  },

  "longread": {
    "videoId": "2025-04-07_psh-sv_gruppa-podderzhki",
    "title": "Подготовка и проведение Группы поддержки",
    "speaker": "Светлана Дмитрук",
    "introduction": "Группа поддержки — один из ключевых инструментов...",
    "conclusion": "Регулярные встречи создают культуру взаимопомощи...",
    "sections": [
      {"index": 1, "title": "Подготовка помещения", "content": "...", "wordCount": 450}
    ],
    "section": "Обучение",
    "subsection": "Работа с командой",
    "tags": ["группа поддержки", "командная работа"],
    "accessLevel": 1,
    "totalWordCount": 3500,
    "modelName": "claude-sonnet-4-5"
  },

  "summary": {
    "videoId": "2025-04-07_psh-sv_gruppa-podderzhki",
    "essence": "Светлана Дмитрук рассказывает о принципах организации Группы поддержки...",
    "keyConcepts": ["Группа поддержки", "Формат полукруга", "Ротация ролей"],
    "practicalTools": ["Чек-лист подготовки", "Шаблон повестки"],
    "quotes": ["Группа поддержки — это не лекция, а диалог"],
    "insight": "Регулярные встречи создают культуру взаимопомощи",
    "actions": ["Определить день для ГП", "Составить список тем"],
    "section": "Обучение",
    "subsection": "Работа с командой",
    "tags": ["группа поддержки", "командная работа"],
    "accessLevel": 1,
    "modelName": "claude-sonnet-4-5"
  }
}
```

### Поля верхнего уровня

> **v0.58+:** API и файл `pipeline_results.json` используют camelCase (см. [ADR-012](adr/012-statistics-tab.md)).

| Поле | Тип | Описание |
|------|-----|----------|
| `version` | string | Версия формата для совместимости |
| `createdAt` | string | Дата/время обработки (ISO 8601) |
| `metadata` | object | Метаданные видео (VideoMetadata) |
| `rawTranscript` | object | Сырая транскрипция от Whisper |
| `displayText` | string | Текст для отображения (с/без таймкодов) |
| `cleanedTranscript` | object | Очищенная транскрипция |
| `slidesExtraction` | object \| null | Извлечённый текст со слайдов (v0.51+, опционально) |
| `chunks` | object | Семантические чанки |
| `longread` | object | Развёрнутый текст (Longread) |
| `summary` | object | Конспект (Summary) |

---

### Расширенные метрики (v0.42+)

С версии v0.42 API response содержит расширенные метрики для отладки промптов и отслеживания стоимости.

#### TokensUsed

Статистика использования токенов LLM:

```json
{
  "tokensUsed": {
    "input": 1850,
    "output": 1720,
    "total": 3570
  }
}
```

| Поле | Тип | Описание |
|------|-----|----------|
| `input` | int | Входные токены (промпт) |
| `output` | int | Выходные токены (ответ LLM) |
| `total` | int | Сумма (computed field) |

#### RawTranscript — расширенные поля

```json
{
  "rawTranscript": {
    "segments": [...],
    "language": "ru",
    "durationSeconds": 301.5,
    "whisperModel": "large-v3-turbo",
    "confidence": 0.94,
    "processingTimeSec": 23.5,
    "chars": 4412,
    "words": 756
  }
}
```

| Поле | Тип | Описание |
|------|-----|----------|
| `confidence` | float \| null | Средняя уверенность Whisper (0-1), рассчитывается из avgLogprob |
| `processingTimeSec` | float \| null | Время транскрибации в секундах |
| `chars` | int | Количество символов (computed) |
| `words` | int | Количество слов (computed) |

#### CleanedTranscript — расширенные поля

```json
{
  "cleanedTranscript": {
    "text": "...",
    "originalLength": 4412,
    "cleanedLength": 4187,
    "modelName": "claude-sonnet-4-5",
    "tokensUsed": {"input": 1850, "output": 1720},
    "cost": 0.0314,
    "processingTimeSec": 6.2,
    "words": 698,
    "changePercent": -5.1
  }
}
```

| Поле | Тип | Описание |
|------|-----|----------|
| `tokensUsed` | TokensUsed \| null | Статистика токенов LLM |
| `cost` | float \| null | Стоимость в USD |
| `processingTimeSec` | float \| null | Время обработки в секундах |
| `words` | int | Количество слов (computed) |
| `changePercent` | float | Процент изменения vs оригинал (computed) |

#### Longread — расширенные поля

```json
{
  "longread": {
    "videoId": "...",
    "title": "...",
    "sections": [...],
    "modelName": "claude-sonnet-4-5",
    "tokensUsed": {"input": 3200, "output": 2800},
    "cost": 0.0516,
    "processingTimeSec": 12.4,
    "chars": 8500
  }
}
```

| Поле | Тип | Описание |
|------|-----|----------|
| `tokensUsed` | TokensUsed \| null | Статистика токенов LLM |
| `cost` | float \| null | Стоимость в USD |
| `processingTimeSec` | float \| null | Время обработки в секундах |
| `chars` | int | Количество символов (computed) |

#### Summary — расширенные поля

```json
{
  "summary": {
    "videoId": "...",
    "essence": "...",
    "modelName": "claude-sonnet-4-5",
    "tokensUsed": {"input": 2100, "output": 890},
    "cost": 0.0196,
    "processingTimeSec": 5.8,
    "chars": 2150,
    "words": 312
  }
}
```

| Поле | Тип | Описание |
|------|-----|----------|
| `tokensUsed` | TokensUsed \| null | Статистика токенов LLM |
| `cost` | float \| null | Стоимость в USD |
| `processingTimeSec` | float \| null | Время обработки в секундах |
| `chars` | int | Количество символов (computed) |
| `words` | int | Количество слов (computed) |

#### Story — расширенные поля

```json
{
  "story": {
    "videoId": "...",
    "names": "...",
    "blocks": [...],
    "modelName": "claude-sonnet-4-5",
    "tokensUsed": {"input": 4500, "output": 3200},
    "cost": 0.0615,
    "processingTimeSec": 18.2,
    "chars": 12500
  }
}
```

| Поле | Тип | Описание |
|------|-----|----------|
| `tokensUsed` | TokensUsed \| null | Статистика токенов LLM |
| `cost` | float \| null | Стоимость в USD |
| `processingTimeSec` | float \| null | Время обработки в секундах |
| `chars` | int | Количество символов (computed) |

#### TranscriptChunks — расширенные поля

```json
{
  "chunks": {
    "chunks": [...],
    "modelName": "deterministic",
    "totalTokens": 680,
    "totalChunks": 3,
    "avgChunkSize": 285
  }
}
```

| Поле | Тип | Описание |
|------|-----|----------|
| `totalTokens` | int \| null | Общее количество токенов во всех чанках (estimated) |

#### SlidesExtractionResult (v0.51+)

Результат извлечения текста со слайдов презентации через Claude Vision API.

```json
{
  "slidesExtraction": {
    "extractedText": "# Слайд 1: Введение\n\nОсновные темы...\n\n## Таблица\n| Колонка 1 | Колонка 2 |\n...",
    "slidesCount": 15,
    "charsCount": 4250,
    "wordsCount": 580,
    "tablesCount": 3,
    "model": "claude-haiku-4-5",
    "tokensUsed": {"input": 45000, "output": 1200, "total": 46200},
    "cost": 0.051,
    "processingTimeSec": 12.4
  }
}
```

| Поле | Тип | Описание |
|------|-----|----------|
| `extractedText` | string | Извлечённый текст в markdown формате |
| `slidesCount` | int | Количество обработанных слайдов |
| `charsCount` | int | Общее количество символов |
| `wordsCount` | int | Общее количество слов |
| `tablesCount` | int | Количество обнаруженных таблиц |
| `model` | string | Модель Claude Vision (haiku/sonnet/opus) |
| `tokensUsed` | TokensUsed \| null | Статистика токенов |
| `cost` | float \| null | Стоимость в USD |
| `processingTimeSec` | float \| null | Время обработки в секундах |

**Примечание:** `slidesExtraction` является опциональным полем в `pipeline_results.json`. Присутствует только если пользователь прикрепил слайды при обработке.

---

## Конфигурационные файлы

### config/glossary.yaml

**Назначение:** Словарь терминов для нормализации транскрипта

```yaml
# Глоссарий терминов Herbalife
# Используется на этапе Clean для замены вариаций на каноническую форму

products:
  - canonical: "Формула 1"
    variations:
      - "формула один"
      - "формула 1"
      - "Ф1"
      - "ф-1"
      - "formula 1"
      - "formula one"
      - "Формула один"
  
  - canonical: "Формула 2"
    variations:
      - "формула два"
      - "формула 2"
      - "Ф2"
      - "ф-2"
  
  - canonical: "Формула 3"
    variations:
      - "формула три"
      - "формула 3"
      - "Ф3"
      - "ф-3"
  
  - canonical: "Протеиновая смесь"
    variations:
      - "протеин микс"
      - "протеин шейк"
      - "protein mix"
      - "белковая смесь"
      - "протеиновый коктейль"
  
  - canonical: "Клеточное питание"
    variations:
      - "клеточное питание"
      - "cellular nutrition"
      - "клеточка"

brand:
  - canonical: "Herbalife"
    variations:
      - "гербалайф"
      - "гербо лайф"
      - "хербалайф"
      - "herbal life"
      - "херба лайф"
      - "Гербалайф"
      - "Хербалайф"
  
  - canonical: "Herbalife Nutrition"
    variations:
      - "гербалайф нутришн"
      - "herbalife nutrition"
      - "херба лайф нутришен"

business:
  - canonical: "Группа поддержки"
    variations:
      - "группа поддержки"
      - "гп"
      - "групповая поддержка"
      - "группа п"
  
  - canonical: "Понедельничная Школа"
    variations:
      - "понедельничная школа"
      - "пш"
      - "школа понедельника"
      - "monday school"
      - "пон школа"
  
  - canonical: "Клуб здорового завтрака"
    variations:
      - "клуб здорового завтрака"
      - "кзз"
      - "клуб завтрака"
      - "breakfast club"
  
  - canonical: "Фитнес-тест"
    variations:
      - "фитнес тест"
      - "фитнес-тест"
      - "велнес тест"
      - "wellness test"

roles:
  - canonical: "Супервайзер"
    variations:
      - "супервайзер"
      - "супервизор"
      - "св"
      - "supervisor"
      - "суперв"
  
  - canonical: "Независимый партнёр"
    variations:
      - "независимый партнер"
      - "независимый партнёр"
      - "нп"
      - "партнер"
      - "партнёр"
  
  - canonical: "Консультант"
    variations:
      - "консультант"
      - "дистрибьютор"
      - "распространитель"
```

### config/events.yaml

**Назначение:** Типы мероприятий и их потоки

```yaml
# Типы мероприятий для парсинга имени файла

event_types:
  ПШ:
    name: "Понедельничная Школа"
    description: "Еженедельное обучение команды"
    streams:
      SV: "Супервайзеры"
      НП: "Независимые партнёры"
  
  ВБ:
    name: "Вебинар"
    description: "Онлайн-обучение"
    streams:
      ALL: "Все участники"
      SV: "Супервайзеры"
      НП: "Независимые партнёры"
  
  МК:
    name: "Мастер-класс"
    description: "Практическое занятие"
    streams:
      ALL: "Все участники"
  
  СОМ:
    name: "SOM (School of Management)"
    description: "Школа управления"
    streams:
      TAB: "TAB Team"
      SV: "Супервайзеры"

# Настройки парсера
parser:
  date_format: "%Y.%m.%d"
  filename_pattern: "{date} {type}.{stream} {title} ({speaker})"
```

---

## Интеграция с БЗ 2.0

### Процесс загрузки (v1.0 — ручной)

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  Транскрибатор  │────▶│  Google Drive   │────▶│   BZ2_Indexer   │
│   /archive/     │     │   /БЗ2/Видео/   │     │   (automatic)   │
└─────────────────┘     └─────────────────┘     └─────────────────┘
        │                       │                       │
        │                       │                       ▼
   Создаёт файлы          Оператор              Индексирует
   transcript_chunks.json  копирует             chunks → embeddings
   summary.md              вручную              summary → file search
```

### Что индексирует BZ2_Indexer

| Файл | Тип индексации | Использование |
|------|----------------|---------------|
| `transcript_chunks.json` | RAG (векторный поиск) | Точные ответы на вопросы |
| `summary.md` | File Search | Поиск видео по описанию |

### Пример поискового запроса

**Пользователь:** "Как проводить группу поддержки?"

**BZ2_RAG:**
1. Находит релевантные chunks из `transcript_chunks.json`
2. Формирует ответ с цитатами
3. Предлагает ссылку на полное видео

---

## Архитектурное решение о совместимости

> **Дата:** 2025-01-20
> **Контекст:** При изменении структуры pipeline (добавление longread, изменение полей summary) старые обработанные файлы перестали открываться в UI.

### Проблема

При версионировании pipeline возникает дилемма:
1. **Строгая проверка версий** → старые файлы не открываются, нужна миграция
2. **Миграция данных** → не работает для семантически несовместимых изменений (нельзя сгенерировать `longread` из старых данных без LLM)
3. **Версионированный UI** → отдельные компоненты для каждой версии, растущая сложность

### Решение: Graceful Degradation

**UI показывает то, что есть в данных, независимо от версии.**

Принципы:
- Все блоки в `pipeline_results.json` опциональны
- UI проверяет наличие блока перед отображением
- Текстовые блоки (longread, summary) рендерятся как plain text без парсинга структуры

```typescript
// Frontend показывает блок только если он есть
{results.longread && <LongreadBlock data={results.longread} />}
{results.summary && <SummaryBlock data={results.summary} />}
```

### ⚠️ Важное ограничение

**Если ввести графическое форматирование** (теги как badges, списки как cards, секции с иконками), то:

1. UI начнёт **зависеть от конкретных полей** (`tags`, `key_concepts`, `sections`)
2. При изменении структуры в новой версии pipeline **старые файлы сломаются**
3. Придётся либо **мигрировать данные**, либо **поддерживать версионированный UI**

**Рекомендация:** Пока pipeline активно развивается, использовать **простой текстовый вывод**. Вводить форматирование только после стабилизации структуры данных.

### Последствия для разработки

| Действие | Совместимость |
|----------|---------------|
| Добавить новый блок (напр. `key_takeaways`) | ✅ Старые файлы работают (блок просто не показывается) |
| Изменить структуру блока (напр. добавить поле в `summary`) | ✅ Работает, если UI не парсит конкретные поля |
| Ввести форматирование по полям (badges для `tags`) | ❌ Старые файлы без `tags` сломаются |
| Переименовать поле (`summary` → `konspekt`) | ❌ Требует миграции или версионированного UI |

---

## Связанные документы

- [architecture.md](architecture.md) — схема системы
- [pipeline/](pipeline/) — этапы обработки
- [configuration.md](configuration.md) — настройки системы
