# План исправлений после аудита v0.26

**Дата аудита:** 2026-01-21
**Статус:** Готов к реализации

---

## Контекст

Аудит согласованности после Pipeline Optimization v0.21-v0.26 выявил несколько несоответствий между модулями. Данный план описывает необходимые исправления.

---

## Критические исправления (блокируют работу)

### 1. ChunkStage конструктор в stages/__init__.py

**Файл:** `backend/app/services/stages/__init__.py`
**Строка:** 114

**Проблема:** ChunkStage в v0.26 не требует ai_client (детерминированное H2 чанкирование), но регистрация передаёт лишний аргумент.

**Текущий код:**
```python
registry.register(ChunkStage(ai_client, settings))
```

**Исправление:**
```python
registry.register(ChunkStage(settings))
```

**Влияние:** Без исправления — TypeError при вызове `create_default_stages()`.

---

### 2. DEFAULT_PIPELINE_STAGES неправильный порядок

**Файл:** `backend/app/services/stages/__init__.py`
**Строки:** 125-134

**Проблема:** Список показывает chunk ПЕРЕД longread/story, хотя в v0.25+ порядок изменён.

**Текущий код:**
```python
DEFAULT_PIPELINE_STAGES = [
    "parse",
    "transcribe",
    "clean",
    "chunk",        # ← неправильно
    "longread",
    "summarize",
    "story",
    "save",
]
```

**Исправление:**
```python
DEFAULT_PIPELINE_STAGES = [
    "parse",
    "transcribe",
    "clean",
    "longread",     # v0.25+: генерация ПЕРЕД чанкированием
    "summarize",
    "story",
    "chunk",        # v0.25+: детерминированное H2 чанкирование
    "save",
]
```

**Влияние:** Документационная ошибка. Orchestrator использует depends_on, поэтому runtime не затронут, но код misleading.

---

### 3. Сломанный тестовый скрипт test_models_comprehensive.py

**Файл:** `scripts/test_models_comprehensive.py`
**Строки:** 35, 327-328, 971-972

**Проблема:** Скрипт импортирует удалённый модуль `chunker.py` и обращается к несуществующему полю `settings.chunker_model`.

**Варианты исправления:**

**Вариант A (рекомендуется):** Удалить chunker-тесты полностью
- Удалить import на строке 35
- Удалить методы тестирования chunker
- Удалить обращения к `settings.chunker_model`

**Вариант B:** Переписать для H2 chunker
- Заменить `SemanticChunker` на `chunk_by_h2` из `app.utils.h2_chunker`
- Тестировать детерминированное чанкирование

**Влияние:** Без исправления — ImportError при запуске скрипта.

---

## Некритические исправления (улучшения)

### 4. MetadataView не отображает content_type

**Файл:** `frontend/src/components/results/MetadataView.tsx`

**Проблема:** Компонент показывает метаданные видео, но не отображает `content_type` (educational/leadership) и `event_category` (regular/offsite).

**Исправление:** Добавить отображение:
```tsx
{metadata.content_type && (
  <div>
    <span className="text-gray-500">Тип контента:</span>
    <span>{metadata.content_type === 'educational' ? 'Обучающий' : 'Лидерская история'}</span>
  </div>
)}
{metadata.event_category && (
  <div>
    <span className="text-gray-500">Категория:</span>
    <span>{metadata.event_category === 'regular' ? 'Регулярное' : 'Выездное'}</span>
  </div>
)}
```

**Влияние:** UX — пользователь не видит тип контента до начала обработки.

---

### 5. config_resolver.py устаревший docstring

**Файл:** `backend/app/services/pipeline/config_resolver.py`
**Строки:** 28-31

**Проблема:** Docstring содержит пример с удалённым `SemanticChunker`.

**Исправление:** Обновить пример:
```python
"""
Example:
    resolver = ConfigResolver(settings)

    # Get settings with longread model override
    custom_settings = resolver.with_model("qwen2.5:14b", "longread")

    # Use in service
    generator = LongreadGenerator(ai_client, custom_settings)
"""
```

**Влияние:** Документация вводит в заблуждение.

---

### 6. Устаревшая документация

**Файлы:**
- `docs/pipeline/04-chunk.md` — описывает LLM-based chunking
- `docs/testing.md` (строка 168) — таблица с SemanticChunker
- `docs/adr/003-shared-utils.md` (строка 154) — пример с SemanticChunker

**Исправление:** Обновить для v0.26:
- Заменить описание SemanticChunker на H2 parsing
- Удалить примеры с `from app.services.chunker`
- Добавить информацию о детерминированном чанкировании

**Влияние:** Misleading documentation для разработчиков.

---

## Порядок выполнения

1. **Критические (обязательно):**
   - [ ] Исправить `stages/__init__.py` (конструктор ChunkStage)
   - [ ] Исправить `stages/__init__.py` (порядок DEFAULT_PIPELINE_STAGES)
   - [ ] Исправить `test_models_comprehensive.py` (удалить chunker тесты)

2. **Некритические (рекомендуется):**
   - [ ] Обновить `MetadataView.tsx` (отображение content_type)
   - [ ] Обновить `config_resolver.py` (docstring)
   - [ ] Обновить документацию (`04-chunk.md`, `testing.md`, ADRs)

---

## Тестирование после исправлений

```bash
# 1. Проверить синтаксис
python3 -m py_compile backend/app/services/stages/__init__.py

# 2. Проверить импорты
cd backend && python3 -c "from app.services.stages import create_default_stages"

# 3. Проверить тестовый скрипт (если исправлен)
python3 scripts/test_models_comprehensive.py --help

# 4. Деплой и функциональный тест
./scripts/deploy.sh
```

---

## Версионирование

После исправлений рекомендуется:
- **Patch версия** (0.26.1) — если только критические исправления
- Без изменения версии — если это hotfix

---

## Примечания

- Код `orchestrator.py` и все stages корректны — проблема только в регистрации
- Frontend workflow корректен — проблема только в отображении
- Документация — низкий приоритет, можно отложить
