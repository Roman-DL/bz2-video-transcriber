# LLM Промпты

> Промпты для Ollama, используемые на этапах очистки, разбиения и саммаризации транскриптов.

## Обзор

| Промпт | Этап | Модель | Назначение |
|--------|------|--------|------------|
| [cleaner.md](#cleanermd) | 3. Clean | qwen2.5:14b | Удаление слов-паразитов |
| [chunker.md](#chunkermd) | 4. Chunk | qwen2.5:14b | Смысловое разбиение |
| [summarizer.md](#summarizermd) | 5. Summarize | qwen2.5:14b | Саммари + классификация |

## Конфигурация LLM

```python
LLM_CONFIG = {
    "model": "qwen2.5:14b",
    "temperature": 0.3,      # Низкая для консистентности
    "num_ctx": 16384,        # Контекст для длинных транскриптов
    "top_p": 0.9,
    "repeat_penalty": 1.1,
}
```

---

## cleaner.md

**Расположение:** `config/prompts/cleaner.md`

**Назначение:** Удаление слов-паразитов, ошибок речи и шума из транскрипта.

> **Важно:** Перед LLM применяется glossary.yaml для нормализации терминологии.

### Промпт

```markdown
Ты — редактор транскриптов обучающих видео. Твоя задача — очистить текст от речевого мусора, сохранив весь смысловой контент.

## Что УДАЛИТЬ:

1. **Слова-паразиты:** "ну", "вот", "как бы", "типа", "короче", "значит", "так сказать", "в общем", "на самом деле", "собственно", "допустим", "скажем так"

2. **Заполнители пауз:** "э-э-э", "м-м-м", "а-а-а", повторы слов, незаконченные фразы

3. **Технические фразы:** "вы меня слышите?", "видно экран?", "сейчас покажу", "подождите секунду", "так, где это...", "ой, не туда нажал"

4. **Отвлечения:** обсуждение технических проблем со связью, посторонние разговоры, комментарии не по теме

## Что СОХРАНИТЬ:

1. **Весь смысловой контент** — факты, советы, примеры, истории
2. **Структуру изложения** — порядок тем, логические переходы
3. **Профессиональную терминологию** — названия продуктов, бизнес-термины
4. **Прямую речь и цитаты** — если спикер кого-то цитирует
5. **Числа и конкретику** — даты, проценты, количества

## Правила:

- НЕ добавляй ничего от себя
- НЕ меняй смысл высказываний
- НЕ удаляй повторения, если они для усиления ("очень-очень важно")
- Сохраняй разговорный стиль, не делай текст "книжным"
- Исправляй очевидные ошибки распознавания речи

## Формат ответа:

Верни ТОЛЬКО очищенный текст без комментариев и пояснений.

---

ТРАНСКРИПТ ДЛЯ ОЧИСТКИ:

{transcript}
```

### Пример

**Вход:**
```
Ну вот, значит, сегодня мы э-э-э поговорим о том, как, ну, правильно проводить Группу поддержки. Это, как бы, очень важный инструмент. Вы меня слышите? Да? Хорошо. Так вот, группа поддержки — это, значит, регулярные встречи команды. Ну, типа, каждую неделю вы собираетесь и, ну, обсуждаете результаты.
```

**Выход:**
```
Сегодня мы поговорим о том, как правильно проводить Группу поддержки. Это очень важный инструмент. Группа поддержки — это регулярные встречи команды. Каждую неделю вы собираетесь и обсуждаете результаты.
```

---

## chunker.md

**Расположение:** `config/prompts/chunker.md`

**Назначение:** Разбиение очищенного транскрипта на смысловые блоки для RAG-индексации.

### Промпт

```markdown
Ты — специалист по структурированию текста. Твоя задача — разбить транскрипт на смысловые блоки (chunks) для поисковой системы.

## Требования к блокам:

1. **Размер:** 100-400 слов (оптимально 200-300)
2. **Смысловая завершённость:** каждый блок — одна законченная мысль или тема
3. **Самодостаточность:** блок должен быть понятен без контекста других блоков
4. **Без перекрытия:** блоки не должны повторять друг друга

## Правила разбиения:

- Разделяй по смене темы или подтемы
- Не разрывай примеры и истории посередине
- Сохраняй логические связки в начале блока ("Также важно...", "Ещё один момент...")
- Если тема большая — раздели на подтемы

## Формат ответа:

Верни JSON-массив объектов. Каждый объект содержит:
- `index`: порядковый номер (начиная с 1)
- `topic`: краткая тема блока (3-7 слов)
- `text`: полный текст блока

```json
[
  {
    "index": 1,
    "topic": "Краткая тема блока",
    "text": "Полный текст блока..."
  },
  {
    "index": 2,
    "topic": "Следующая тема",
    "text": "Текст следующего блока..."
  }
]
```

ВАЖНО: Верни ТОЛЬКО валидный JSON без комментариев и markdown-разметки.

---

ТРАНСКРИПТ ДЛЯ РАЗБИЕНИЯ:

{transcript}
```

### Пример

**Вход:**
```
Сегодня мы поговорим о Группе поддержки. Это регулярные встречи команды для обмена опытом и мотивации. Оптимально проводить их раз в неделю.

Для подготовки встречи вам нужно выбрать тему. Тема должна быть актуальной для участников. Подготовьте 3-5 вопросов для обсуждения. Также полезно иметь раздаточные материалы.

Во время встречи важно вовлекать всех участников. Задавайте открытые вопросы. Давайте каждому возможность высказаться. Фиксируйте ключевые идеи на флипчарте.
```

**Выход:**
```json
[
  {
    "index": 1,
    "topic": "Что такое Группа поддержки",
    "text": "Сегодня мы поговорим о Группе поддержки. Это регулярные встречи команды для обмена опытом и мотивации. Оптимально проводить их раз в неделю."
  },
  {
    "index": 2,
    "topic": "Подготовка к встрече",
    "text": "Для подготовки встречи вам нужно выбрать тему. Тема должна быть актуальной для участников. Подготовьте 3-5 вопросов для обсуждения. Также полезно иметь раздаточные материалы."
  },
  {
    "index": 3,
    "topic": "Вовлечение участников",
    "text": "Во время встречи важно вовлекать всех участников. Задавайте открытые вопросы. Давайте каждому возможность высказаться. Фиксируйте ключевые идеи на флипчарте."
  }
]
```

---

## summarizer.md

**Расположение:** `config/prompts/summarizer.md`

**Назначение:** Создание саммари с классификацией для БЗ 2.0.

### Промпт

````markdown
Ты — ассистент для создания структурированных конспектов обучающих видео. Создай саммари на основе транскрипции.

## Метаданные видео:

- **Название:** {title}
- **Спикер:** {speaker}
- **Дата:** {date}
- **Мероприятие:** {event_type} — {stream_name}

## Формат ответа:

Верни JSON-объект со следующей структурой:

```json
{
  "summary": "2-3 абзаца с кратким содержанием. Что рассказывает спикер, какие темы затрагивает, какова главная идея.",
  
  "key_points": [
    "Ключевой тезис 1",
    "Ключевой тезис 2",
    "Ключевой тезис 3",
    "Ключевой тезис 4",
    "Ключевой тезис 5"
  ],
  
  "recommendations": [
    "Практическая рекомендация 1",
    "Практическая рекомендация 2",
    "Практическая рекомендация 3"
  ],
  
  "target_audience": "Для кого будет полезно это видео (1-2 предложения)",
  
  "questions_answered": [
    "На какой вопрос отвечает видео?",
    "Ещё один вопрос",
    "И ещё один"
  ],
  
  "classification": {
    "section": "Один из: Обучение, Продукты, Бизнес, Мотивация",
    "subsection": "Подраздел внутри секции",
    "tags": ["тег1", "тег2", "тег3", "тег4", "тег5"],
    "access_level": 1
  }
}
```

## Правила классификации:

### Секции (section):
- **Обучение** — тренинги, развитие навыков, методики работы
- **Продукты** — информация о продуктах Herbalife, применение, результаты
- **Бизнес** — построение бизнеса, продажи, рекрутинг, управление
- **Мотивация** — истории успеха, вдохновение, личностный рост

### Уровни доступа (access_level):
- **1** — для всех консультантов (базовая информация)
- **2** — для спонсоров (продвинутые темы)
- **3** — для TAB Team (управленческие темы)
- **4** — для администраторов (внутренняя информация)

### Теги:
- 5-7 релевантных тегов
- Используй существительные в именительном падеже
- Включай: тему, навыки, продукты, аудиторию

ВАЖНО: Верни ТОЛЬКО валидный JSON без комментариев и markdown-разметки.

---

ТРАНСКРИПТ:

{transcript}
````

### Пример

**Вход (метаданные):**
```
title: "Подготовка и проведение Группы поддержки"
speaker: "Светлана Дмитрук"
date: "2025-04-07"
event_type: "ПШ"
stream_name: "Понедельничная Школа — Супервайзеры"
```

**Вход (транскрипт):** [очищенный транскрипт о Группе поддержки]

**Выход:**
```json
{
  "summary": "Светлана Дмитрук рассказывает о ключевых принципах организации и проведения Группы поддержки — регулярных встреч команды консультантов Herbalife. Видео охватывает полный цикл: от подготовки помещения и повестки до техник вовлечения участников и работы с возражениями.\n\nОсобое внимание уделяется созданию атмосферы доверия и поддержки, где каждый участник чувствует себя ценным членом команды. Спикер делится практическими инструментами для повышения эффективности встреч.",
  
  "key_points": [
    "Группа поддержки — это не лекция, а диалог между участниками",
    "Оптимальное количество участников: 8-15 человек",
    "Регулярность важнее длительности: лучше 1 час каждую неделю",
    "Каждая встреча должна иметь чёткую тему и практический результат",
    "Ротация ролей повышает вовлечённость участников"
  ],
  
  "recommendations": [
    "За 2-3 дня определите тему и подготовьте 3-5 вопросов для обсуждения",
    "Первые 5 минут — позитивные новости от участников",
    "Каждый участник формулирует один action item на неделю",
    "Напомните об action items в групповом чате через 3 дня"
  ],
  
  "target_audience": "Видео будет полезно супервайзерам и старшим консультантам, которые хотят повысить эффективность командных встреч и создать культуру взаимоподдержки.",
  
  "questions_answered": [
    "Как подготовить и провести эффективную Группу поддержки?",
    "Какой оптимальный формат и длительность встречи?",
    "Как вовлечь пассивных участников в обсуждение?",
    "Как работать с негативом на встрече?"
  ],
  
  "classification": {
    "section": "Обучение",
    "subsection": "Работа с командой",
    "tags": ["группа поддержки", "командная работа", "мотивация", "обучение консультантов", "организация мероприятий"],
    "access_level": 1
  }
}
```

---

## Работа с ошибками LLM

### Невалидный JSON

```python
def parse_llm_json(response: str) -> dict:
    """Извлечение JSON из ответа LLM с обработкой ошибок."""
    
    # Убираем markdown-разметку
    cleaned = response.strip()
    if cleaned.startswith("```"):
        cleaned = re.sub(r'^```\w*\n?', '', cleaned)
        cleaned = re.sub(r'\n?```$', '', cleaned)
    
    try:
        return json.loads(cleaned)
    except json.JSONDecodeError as e:
        # Попытка исправить частые ошибки
        cleaned = cleaned.replace("'", '"')  # Одинарные кавычки
        cleaned = re.sub(r',\s*}', '}', cleaned)  # Trailing commas
        cleaned = re.sub(r',\s*]', ']', cleaned)
        
        return json.loads(cleaned)
```

### Retry при ошибках

```python
@retry(
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=1, min=2, max=10),
    retry=retry_if_exception_type((json.JSONDecodeError, OllamaError))
)
async def call_llm_with_retry(prompt: str, config: dict) -> dict:
    """Вызов LLM с retry логикой."""
    response = await ollama.generate(
        model=config["model"],
        prompt=prompt,
        options=config
    )
    return parse_llm_json(response["response"])
```

---

## Связанные документы

- [pipeline.md](pipeline.md) — где используются промпты
- [data-formats.md](data-formats.md) — форматы выходных файлов
- [architecture.md](architecture.md) — общая схема системы
