# Этап 5: Summarize (+ Classification)

[< Назад: Chunk](04-chunk.md) | [Обзор Pipeline](README.md) | [Далее: Save >](06-save.md)

---

## Назначение

Создание структурированного саммари для File Search в БЗ 2.0.

## Интеграция с Outline

Для больших текстов (>10K символов) summarizer использует **TranscriptOutline** вместо полного транскрипта:

```
CleanedTranscript ──> [Outline Extraction] ──> TranscriptOutline (~1K токенов)
                                                       │
                                              ┌────────┴────────┐
                                              ▼                 ▼
                                          Chunker          Summarizer
                                              │                 │
                                              ▼                 ▼
                                     TranscriptChunks     VideoSummary
```

**Почему outline:**
- Входные токены: ~1K вместо ~50K
- Время: ~5-10 сек вместо ~30-60 сек
- Стабильность: меньший контекст = меньше ошибок LLM
- Нет дублирования: outline создаётся один раз для обоих сервисов

**Fallback для маленьких текстов (<10K):** используется полный транскрипт.

## Структура ответа LLM

```json
{
  "summary": "2-3 абзаца о содержании видео",
  "key_points": ["тезис 1", "тезис 2", "..."],
  "recommendations": ["рекомендация 1", "..."],
  "target_audience": "для кого полезно",
  "questions_answered": ["вопрос 1", "..."],
  "classification": {
    "section": "Обучение|Продукты|Бизнес|Мотивация",
    "subsection": "подкатегория",
    "tags": ["тег1", "тег2", "..."],
    "access_level": 1
  }
}
```

## Классификация

### Секции

| Секция | Описание |
|--------|----------|
| Обучение | Методики, техники, навыки, тренинги |
| Продукты | Продукция Herbalife, применение, результаты |
| Бизнес | Построение бизнеса, рекрутинг, продажи |
| Мотивация | Истории успеха, вдохновение, личностный рост |

### Уровни доступа

| Уровень | Аудитория |
|---------|-----------|
| 1 | Все консультанты (базовая информация) |
| 2 | Спонсоры (продвинутые темы) |
| 3 | TAB Team (управленческие темы) |
| 4 | Администраторы (внутренняя информация) |

## Динамический выбор промпта

Для итеративной настройки формата можно создавать разные версии:

| Файл | Назначение |
|------|------------|
| `config/prompts/summarizer.md` | Основной промпт |
| `config/prompts/summarizer_v2.md` | Тестовая версия |

После подбора лучшего варианта — переименовать в `summarizer.md`.

## Step-by-step режим

В режиме пошаговой отладки (`/api/steps/summarize`) сервис сам извлекает outline если текст большой. Это сохраняет независимость от full pipeline.

---

## Связанные файлы

- **Сервис:** `backend/app/services/summarizer.py`
- **Модели:** `backend/app/models/schemas.py` → `VideoSummary`
- **Промпт:** `config/prompts/summarizer.md`
