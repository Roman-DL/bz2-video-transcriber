# Этап 1: Parse Filename

[Обзор Pipeline](README.md) | [Далее: Transcribe >](02-transcribe.md)

---

## Назначение

Извлечение метаданных из имени видеофайла по установленному паттерну.

## Паттерн имени файла

```
{дата} {мероприятие}[.{часть}] {тема} ({спикер}).{ext}
```

**Примеры:**
- `2025.04.07 ПШ.SV Группа поддержки (Светлана Дмитрук).mp4` — с частью
- `2025.04.07 ПШ Группа поддержки (Светлана Дмитрук).mp4` — без части

**Часть (stream) опциональна** — не все мероприятия имеют разделение на части.

**Поддерживаемые форматы:** `.mp4`, `.mkv` и другие видеофайлы.

## Структура архива

Обработанные материалы сохраняются в иерархическую структуру:

```
archive/
  {год}/
    {дата} {мероприятие}/
      [{часть}] {тема} ({спикер})/
        video.mp4
        transcript_raw.txt
        transcript_chunks.json
        summary.md
```

**Примеры:**
- С частью: `2025/12.22 ПШ/SV Группа поддержки (Светлана)/`
- Без части: `2025/12.22 ПШ/Группа поддержки (Светлана)/`

**Почему такая структура:**
- Год на верхнем уровне — удобная навигация по времени
- Дата + мероприятие — группировка записей одного события
- Часть в названии папки темы — плоская структура без лишней вложенности

## Генерация video_id

Уникальный идентификатор видео формируется как:

```
{дата}_{мероприятие}[-{часть}]_{slug-темы}
```

**Примеры:**
- `2025-04-07_ПШ-SV_группа-поддержки` — с частью
- `2025-04-07_ПШ_группа-поддержки` — без части

Slug сохраняет кириллицу в lowercase.

## Валидация

Типы мероприятий и их части валидируются по конфигу `config/events.yaml`.
При неизвестном типе/части выводится warning, но обработка продолжается.

## Error Handling

При несоответствии имени файла паттерну выбрасывается `FilenameParseError` с понятным сообщением об ожидаемом формате.

## Тестирование

```bash
python -m backend.app.services.parser
```

**Тесты покрывают:**
- Парсинг с частью и без части
- Генерация video_id
- Формирование archive_path
- Обработка некорректных имён
- Функция slugify

---

## Связанные документы

- **Код:** [`backend/app/services/parser.py`](../../backend/app/services/parser.py)
- **Модели:** [`backend/app/models/schemas.py`](../../backend/app/models/schemas.py)
- **Типы мероприятий:** [`config/events.yaml`](../../config/events.yaml)
