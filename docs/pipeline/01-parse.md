# Этап 1: Parse Filename

[Обзор Pipeline](README.md) | [Далее: Transcribe >](02-transcribe.md)

---

## Назначение

Извлечение метаданных из имени видеофайла по установленному паттерну. Автоматическое определение типа контента (`ContentType`) и категории события (`EventCategory`).

## Категории событий (v0.21+)

События делятся на две категории:

| Категория | EventCategory | Источник | Пример |
|-----------|---------------|----------|--------|
| Регулярные | `REGULAR` | Еженедельные школы | ПШ, ГП, ФК |
| Выездные | `OFFSITE` | Выездные мероприятия | Лидерство, Обучение |

## Типы контента (v0.21+)

Контент автоматически классифицируется по паттерну имени файла:

| Тип | ContentType | Паттерн имени | Пример |
|-----|-------------|---------------|--------|
| Образовательный | `EDUCATIONAL` | `{Часть} {Тема} ({Спикер})` или `{Фамилия} — {Название}` | `SV Группа поддержки (Светлана)`, `Иванов — Продукты` |
| Лидерство | `LEADERSHIP` | `{Фамилия} ({Имя})` | `Антоновы (Дмитрий и Юлия)` |

## Паттерны имени файла

### Регулярные события (ПШ, ГП, и т.д.)

```
{дата} {мероприятие}[.{часть}] {тема} ({спикер}).{ext}
```

**Примеры:**
- `2025.04.07 ПШ.SV Группа поддержки (Светлана Дмитрук).mp4` — с частью
- `2025.04.07 ПШ Группа поддержки (Светлана Дмитрук).mp4` — без части

**Часть (stream) опциональна** — не все мероприятия имеют разделение на части.

### Выездные события (offsite)

Файлы размещаются в именованных папках:

```
inbox/
  {название события}/
    {Фамилия} ({Имя}).mp4           # leadership
    {Фамилия} — {Название}.mp4      # educational
```

**Примеры:**
- `inbox/Выезд 2025.01/Антоновы (Дмитрий и Юлия).mp4` → leadership
- `inbox/Выезд 2025.01/Иванов — Как строить бизнес.mp4` → educational

**Поддерживаемые форматы:** `.mp4`, `.mkv` и другие видеофайлы.

## Структура архива

### Регулярные события

```
archive/
  {год}/
    {мероприятие}/
      {MM.DD}/
        [{часть}] {тема} ({спикер})/
          video.mp4
          transcript_raw.txt
          transcript_chunks.json
          summary.md
          pipeline_results.json
```

**Пример:** `archive/2025/ПШ/01.09/SV Группа поддержки (Светлана)/`

### Выездные события

```
archive/
  {год}/
    Выездные/
      {название события}/
        {тема}/
          video.mp4
          ...
```

**Пример:** `archive/2025/Выездные/Выезд 2025.01/Антоновы (Дмитрий и Юлия)/`

**Почему такая структура:**
- Год на верхнем уровне — удобная навигация по времени
- Группировка по типу события (ПШ, ГП) или "Выездные"
- Дата в отдельной папке для регулярных событий — чёткое разделение по датам
- Название события для выездных — логическая группировка материалов одного мероприятия

## Генерация video_id

Уникальный идентификатор видео формируется как:

```
{дата}_{мероприятие}[-{часть}]_{slug-темы}
```

**Примеры:**
- `2025-04-07_ПШ-SV_группа-поддержки` — с частью
- `2025-04-07_ПШ_группа-поддержки` — без части

Slug сохраняет кириллицу в lowercase.

## Валидация

Типы мероприятий и их части валидируются по конфигу `config/events.yaml`.
При неизвестном типе/части выводится warning, но обработка продолжается.

## Error Handling

При несоответствии имени файла паттерну выбрасывается `FilenameParseError` с понятным сообщением об ожидаемом формате.

## Тестирование

```bash
cd backend
source .venv/bin/activate  # macOS требует venv
python -m app.services.parser
```

**Тесты покрывают:**
- Парсинг регулярных событий (с частью и без)
- Парсинг выездных событий (leadership и educational)
- Определение ContentType по паттерну имени
- Генерация video_id
- Формирование archive_path для обеих категорий
- Обработка некорректных имён
- Функция slugify

---

## Связанные документы

- **Код:** [`backend/app/services/parser.py`](../../backend/app/services/parser.py)
- **Модели:** [`backend/app/models/schemas.py`](../../backend/app/models/schemas.py)
- **Типы мероприятий:** [`config/events.yaml`](../../config/events.yaml)
