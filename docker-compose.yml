services:
  bz2-transcriber:
    build: ./backend
    container_name: bz2-transcriber
    restart: unless-stopped
    ports:
      - "8801:80"
    volumes:
      # Data - videos and processing results
      - /mnt/main/work/bz2/video:/data:rw
      # Configuration - prompts, glossary
      - ./config:/app/config:ro
    environment:
      # AI services
      - OLLAMA_URL=http://192.168.1.152:11434
      - WHISPER_URL=http://192.168.1.152:9000
      - SUMMARIZER_MODEL=qwen2.5:14b
      - CLEANER_MODEL=gemma2:9b
      # Paths
      - DATA_ROOT=/data
      - INBOX_DIR=/data/inbox
      - ARCHIVE_DIR=/data/archive
      - TEMP_DIR=/data/temp
      - CONFIG_DIR=/app/config
      # Settings
      - WHISPER_LANGUAGE=ru
      - LLM_TIMEOUT=300
      # Cloud AI (optional)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      # Proxy for external APIs (required for blocked services like Claude)
      - HTTP_PROXY=http://192.168.1.152:7890
      - HTTPS_PROXY=http://192.168.1.152:7890
      - NO_PROXY=localhost,127.0.0.1,192.168.1.0/24,100.64.0.0/10
      # Logging
      - LOG_LEVEL=INFO
      - LOG_FORMAT=structured
      - LOG_LEVEL_AI_CLIENT=DEBUG
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  bz2-frontend:
    build: ./frontend
    container_name: bz2-frontend
    restart: unless-stopped
    ports:
      - "8802:80"
    depends_on:
      - bz2-transcriber
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
